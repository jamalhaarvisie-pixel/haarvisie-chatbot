<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Haarvisie AI Chatbot + Intake</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
.chat-container{width:100%;max-width:900px;height:90vh;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);display:flex;flex-direction:column;overflow:hidden}
.chat-header{background:linear-gradient(135deg,#2c3e50 0%,#4a5568 100%);color:white;padding:15px 20px;display:flex;align-items:center;gap:15px}
.logo{width:45px;height:45px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px}
.header-info h1{font-size:1.3rem;margin-bottom:2px}
.header-info p{font-size:0.8rem;opacity:0.8}
.header-buttons{margin-left:auto;display:flex;gap:8px;align-items:center}
.header-btn{padding:6px 12px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
.header-btn:hover{background:rgba(255,255,255,0.3)}
.api-status{padding:6px 12px;border-radius:15px;font-size:0.75rem;font-weight:600}
.api-status.connected{background:#48bb78}
.api-status.disconnected{background:#f56565}
.chat-messages{flex:1;overflow-y:auto;padding:20px;background:#f7fafc}
.message{max-width:85%;margin-bottom:15px;animation:fadeIn 0.3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.message.user{margin-left:auto}
.message.bot{margin-right:auto}
.message-content{padding:15px 20px;border-radius:18px;line-height:1.5}
.message.user .message-content{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-bottom-right-radius:4px}
.message.bot .message-content{background:white;color:#2d3748;border-bottom-left-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.intake-question{margin-top:15px;padding:15px;background:#f0f4ff;border-radius:12px;border-left:4px solid #667eea}
.intake-question h4{color:#4a5568;margin-bottom:10px;font-size:0.95rem}
.intake-options{display:flex;flex-wrap:wrap;gap:8px}
.intake-btn{padding:10px 16px;background:white;border:2px solid #e2e8f0;border-radius:20px;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.intake-btn:hover{border-color:#667eea;background:#f0f4ff;transform:scale(1.02)}
.intake-btn.selected{background:#667eea;color:white;border-color:#667eea}
.intake-btn.multi{border-radius:8px}
.intake-btn.multi.selected{background:#48bb78;border-color:#48bb78}
.intake-checkbox{width:18px;height:18px;border:2px solid #cbd5e0;border-radius:4px;display:flex;align-items:center;justify-content:center}
.intake-btn.selected .intake-checkbox{background:white;border-color:white}
.intake-btn.selected .intake-checkbox::after{content:'â';color:#48bb78;font-weight:bold}
.intake-next{margin-top:12px;padding:12px 24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:25px;cursor:pointer;font-size:0.95rem;font-weight:600}
.intake-next:disabled{opacity:0.5;cursor:not-allowed}
.intake-next:not(:disabled):hover{transform:scale(1.02)}
.intake-progress{display:flex;gap:4px;margin-bottom:10px}
.progress-dot{width:8px;height:8px;border-radius:50%;background:#e2e8f0}
.progress-dot.active{background:#667eea}
.progress-dot.done{background:#48bb78}
.photo-upload-area{margin-top:10px;padding:20px;border:2px dashed #cbd5e0;border-radius:12px;text-align:center;cursor:pointer;transition:all 0.2s}
.photo-upload-area:hover{border-color:#667eea;background:#f0f4ff}
.photo-upload-area.has-photo{border-style:solid;border-color:#48bb78;background:#f0fff4}
.uploaded-preview{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.uploaded-preview img{width:80px;height:80px;object-fit:cover;border-radius:8px}
.chat-input-area{padding:15px 20px;background:white;border-top:1px solid #e2e8f0}
.input-row{display:flex;gap:10px;align-items:flex-end}
.input-wrapper{flex:1;position:relative}
.input-wrapper textarea{width:100%;padding:12px 45px 12px 15px;border:2px solid #e2e8f0;border-radius:20px;font-size:0.95rem;resize:none;min-height:45px;max-height:120px}
.input-wrapper textarea:focus{outline:none;border-color:#667eea}
.attach-btn{position:absolute;right:12px;bottom:10px;background:none;border:none;cursor:pointer;font-size:1.2rem;opacity:0.6}
.attach-btn:hover{opacity:1}
.send-btn{width:45px;height:45px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:50%;cursor:pointer;font-size:1.1rem}
.panel{display:none;padding:15px 20px;background:#f7fafc;border-bottom:1px solid #e2e8f0}
.panel.active{display:block}
.settings-row{display:flex;align-items:center;gap:10px}
.settings-row input{flex:1;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px}
.settings-btn{padding:6px 12px;background:#667eea;color:white;border:none;border-radius:5px;cursor:pointer}
.typing-indicator{display:flex;gap:5px;padding:15px 20px;background:white;border-radius:18px;width:fit-content;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.typing-indicator span{width:8px;height:8px;background:#a0aec0;border-radius:50%;animation:typing 1.4s infinite}
.typing-indicator span:nth-child(2){animation-delay:0.2s}
.typing-indicator span:nth-child(3){animation-delay:0.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
.feedback-bar{display:flex;gap:8px;margin-top:10px}
.feedback-btn{padding:6px 12px;border:none;border-radius:15px;cursor:pointer;font-size:0.8rem;display:flex;align-items:center;gap:5px;transition:all 0.2s}
.feedback-btn.good{background:#c6f6d5;color:#22543d}
.feedback-btn.correct{background:#fed7d7;color:#822727}
#fileInput{display:none}
.price-tag{display:inline-block;background:linear-gradient(135deg,#48bb78 0%,#38a169 100%);color:white;padding:3px 10px;border-radius:12px;font-weight:600;font-size:0.85rem;margin:2px}
</style>
</head>
<body>
<div class="chat-container">
<div class="chat-header">
<div class="logo">ð</div>
<div class="header-info"><h1>Haarvisie AI Assistent</h1><p>Met intake vragenlijst</p></div>
<div class="header-buttons">
<button class="header-btn" onclick="startIntake()">ð Nieuwe Intake</button>
<button class="header-btn" onclick="togglePanel()">âï¸</button>
<div class="api-status disconnected" id="apiStatus">Niet verbonden</div>
</div>
</div>
<div class="panel" id="settingsPanel"><div class="settings-row"><label>API Key:</label><input type="password" id="apiKeyInput" placeholder="Voer je Gemini API key in"><button class="settings-btn" onclick="saveApiKey()">Opslaan</button></div></div>
<div class="chat-messages" id="chatMessages"><div class="message bot"><div class="message-content"><strong>Welkom bij Haarvisie! ð</strong><br><br>Klik op <strong>ð Nieuwe Intake</strong> om te beginnen met de intake vragenlijst, of stel direct een vraag.</div></div></div>
<div class="chat-input-area"><div class="input-row"><div class="input-wrapper"><textarea id="messageInput" placeholder="Of stel hier direct je vraag..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea><button class="attach-btn" onclick="document.getElementById('fileInput').click()">ð</button></div><button class="send-btn" onclick="sendMessage()">â¤</button></div><input type="file" id="fileInput" multiple accept="image/*" onchange="handleFileSelect(event)"></div>
</div>
<script>
let API_KEY=localStorage.getItem('gemini_api_key')||'';
const API_URL='https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
let uploadedPhotos=[];
let intakeData={};
let currentQuestion=0;
let currentPhotoType='current';
let messageCounter=0;

const INTAKE_QUESTIONS=[
{id:'service',question:'Welke service wil je?',type:'single',options:[
{value:'knippen',label:'âï¸ Knippen'},{value:'kleuren',label:'ð¨ Kleuren'},{value:'highlights',label:'ð¡ Highlights/Balayage'},{value:'behandeling',label:'ð Behandeling'},{value:'styling',label:'ð Styling/FÃ¶hnen'},{value:'combinatie',label:'ð Combinatie'}]},
{id:'current_color',question:'Wat is je huidige haarkleur?',type:'single',options:[
{value:'blond',label:'ð± Blond'},{value:'bruin',label:'ð¤ Bruin'},{value:'zwart',label:'â¬ Zwart'},{value:'rood',label:'ð´ Rood'},{value:'grijs',label:'â¬ Grijs/wit'},{value:'gekleurd',label:'ð Fantasie kleur'}]},
{id:'colored_before',question:'Is je haar eerder gekleurd?',type:'single',options:[
{value:'nee',label:'â Nee, natuurlijk haar'},{value:'ja_salon',label:'â Ja, bij een salon'},{value:'ja_zelf',label:'ð  Ja, zelf thuis gekleurd'},{value:'ja_beide',label:'ð Beide'}]},
{id:'color_history',question:'Wat is er de afgelopen 2 jaar met je haar gedaan?',type:'multi',options:[
{value:'highlights',label:'ð¡ Highlights/lowlights'},{value:'ontkleurd',label:'â¡ Ontkleurd/gebleekt'},{value:'donkerder',label:'ð Donkerder geverfd'},{value:'henna',label:'ð¿ Henna'},{value:'permanent',label:'ð Permanent'},{value:'niets',label:'â¨ Niets'}]},
{id:'hair_condition',question:'Hoe is je haarkwaliteit?',type:'single',options:[
{value:'gezond',label:'ðª Gezond en sterk'},{value:'normaal',label:'ð Normaal'},{value:'droog',label:'ðï¸ Droog/pluizig'},{value:'beschadigd',label:'â ï¸ Beschadigd'},{value:'dun',label:'ðª¶ Fijn/dun'}]},
{id:'products',question:'Welke producten gebruik je thuis?',type:'multi',options:[
{value:'olaplex',label:'ð Olaplex'},{value:'kerastase',label:'ð§´ KÃ©rastase'},{value:'andrelon',label:'ð Supermarkt'},{value:'masker',label:'ð­ Haarmaskers'},{value:'hittetools',label:'ð¥ Stijltang/fÃ¶hn'},{value:'geen',label:'â Geen speciale'}]},
{id:'photo_current',question:'ð¸ Upload een foto van je HUIDIGE haar',type:'photo',photoType:'current',description:'Maak een foto in daglicht'},
{id:'photo_wish',question:'ð¯ Upload een WENSFOTO (inspiratie)',type:'photo',photoType:'wish',description:'Upload je droomkapsel/kleur'},
{id:'wish',question:'Beschrijf kort je wens (optioneel)',type:'text',placeholder:'Bijv: Ik wil lichter worden met een natuurlijke uitstraling...'}
];

document.addEventListener('DOMContentLoaded',()=>{checkApiKey()});

function checkApiKey(){const s=document.getElementById('apiStatus');s.textContent=API_KEY?'Verbonden':'Niet verbonden';s.className='api-status '+(API_KEY?'connected':'disconnected')}

function togglePanel(){document.getElementById('settingsPanel').classList.toggle('active')}

function saveApiKey(){API_KEY=document.getElementById('apiKeyInput').value.trim();localStorage.setItem('gemini_api_key',API_KEY);checkApiKey();togglePanel();addBotMessage('â API key opgeslagen!')}

function startIntake(){intakeData={};currentQuestion=0;uploadedPhotos=[];addBotMessage('ð <strong>Intake Vragenlijst</strong><br>Beantwoord de volgende vragen zodat ik je het beste kan adviseren.');setTimeout(()=>showIntakeQuestion(currentQuestion),500)}

function showIntakeQuestion(qIndex){
if(qIndex>=INTAKE_QUESTIONS.length){finishIntake();return}
const q=INTAKE_QUESTIONS[qIndex];
const progress=INTAKE_QUESTIONS.map((x,i)=>'<span class="progress-dot '+(i<qIndex?'done':i===qIndex?'active':'')+'"></span>').join('');
let content='<div class="intake-question"><div class="intake-progress">'+progress+'</div><h4>'+q.question+'</h4>';
if(q.description)content+='<p style="font-size:0.85rem;color:#718096;margin-bottom:10px">'+q.description+'</p>';

if(q.type==='single'){
content+='<div class="intake-options">'+q.options.map(o=>'<button class="intake-btn" onclick="selectOption(\''+q.id+'\',\''+o.value+'\',this)">'+o.label+'</button>').join('')+'</div>';
}else if(q.type==='multi'){
content+='<div class="intake-options">'+q.options.map(o=>'<button class="intake-btn multi" onclick="toggleMulti(\''+q.id+'\',\''+o.value+'\',this)"><span class="intake-checkbox"></span>'+o.label+'</button>').join('')+'</div><button class="intake-next" id="nextBtn" onclick="nextQuestion()" disabled>Volgende â</button>';
}else if(q.type==='photo'){
currentPhotoType=q.photoType||'current';
content+='<div class="photo-upload-area" id="photoArea" onclick="document.getElementById(\'photoInput\').click()"><input type="file" id="photoInput" accept="image/*" multiple onchange="handleIntakePhoto(event)" style="display:none">ð· Klik om foto te uploaden<div class="uploaded-preview" id="photoPreview"></div></div><button class="intake-next" onclick="nextQuestion()">'+((q.photoType==='wish')?'Overslaan / Volgende â':'Volgende â')+'</button>';
}else if(q.type==='text'){
content+='<textarea id="txt-'+q.id+'" placeholder="'+(q.placeholder||'')+'" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:12px;min-height:80px;font-size:0.95rem;margin-top:10px"></textarea><button class="intake-next" onclick="saveText(\''+q.id+'\')">Volgende â</button>';
}
content+='</div>';
addBotHtml(content);
}

function selectOption(qid,val,btn){intakeData[qid]=val;btn.parentElement.querySelectorAll('.intake-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');setTimeout(()=>{currentQuestion++;showIntakeQuestion(currentQuestion)},400)}

function toggleMulti(qid,val,btn){
if(!intakeData[qid])intakeData[qid]=[];
const idx=intakeData[qid].indexOf(val);
if(idx>-1){intakeData[qid].splice(idx,1);btn.classList.remove('selected')}
else{intakeData[qid].push(val);btn.classList.add('selected')}
document.getElementById('nextBtn').disabled=intakeData[qid].length===0;
}

function handleIntakePhoto(e){
Array.from(e.target.files).forEach(f=>{
if(f.type.startsWith('image/')){
const r=new FileReader();
r.onload=ev=>{uploadedPhotos.push({data:ev.target.result,type:currentPhotoType});updatePhotoPreview()};
r.readAsDataURL(f);
}
});
}

function updatePhotoPreview(){
const photos=uploadedPhotos.filter(p=>p.type===currentPhotoType);
const area=document.getElementById('photoArea');
const preview=document.getElementById('photoPreview');
if(photos.length){area.classList.add('has-photo');preview.innerHTML='â '+photos.length+' foto geÃ¼pload<br>'+photos.map(p=>'<img src="'+p.data+'">').join('')}
}

function saveText(qid){intakeData[qid]=document.getElementById('txt-'+qid).value;nextQuestion()}

function nextQuestion(){currentQuestion++;showIntakeQuestion(currentQuestion)}

function finishIntake(){addBotMessage('â <strong>Intake compleet!</strong><br><br>Even geduld, ik analyseer je gegevens...');showTyping();generateAdvice()}

async function generateAdvice(){
if(!API_KEY){hideTyping();addBotMessage('â ï¸ Voer eerst je API key in via âï¸');return}
try{const r=await callGemini();hideTyping();addBotMsgFb(r)}catch(e){hideTyping();addBotMessage('â ï¸ '+e.message)}
}

async function callGemini(){
const prompt='Je bent Haarvisie AI. INTAKE: Behandeling:'+intakeData.service+', Kleur:'+intakeData.current_color+', Gekleurd:'+intakeData.colored_before+', Conditie:'+intakeData.hair_condition+', Wens:'+intakeData.wish+'. PRIJZEN: Highlights â¬325, Balayage â¬185, Kleuren â¬95, Kleuring â¬175. Analyseer de foto van het huidige haar en vergelijk met de wensfoto (indien aanwezig). Geef advies, prijs en waarschuw bij risicos.';
const parts=[{text:prompt}];
uploadedPhotos.filter(p=>p.type==='current').forEach(p=>parts.push({inlineData:{mimeType:'image/jpeg',data:p.data.split(',')[1]}}));
uploadedPhotos.filter(p=>p.type==='wish').forEach(p=>parts.push({inlineData:{mimeType:'image/jpeg',data:p.data.split(',')[1]}}));
const res=await fetch(API_URL+'?key='+API_KEY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts}],generationConfig:{temperature:0.7,maxOutputTokens:1024}})});
if(!res.ok)throw new Error('API fout');
const d=await res.json();return d.candidates[0].content.parts[0].text;
}

function addUserMsg(t){document.getElementById('chatMessages').innerHTML+='<div class="message user"><div class="message-content">'+escHtml(t)+'</div></div>';scrollToBottom()}
function addBotMessage(t){document.getElementById('chatMessages').innerHTML+='<div class="message bot"><div class="message-content">'+t+'</div></div>';scrollToBottom()}
function addBotHtml(h){document.getElementById('chatMessages').innerHTML+='<div class="message bot"><div class="message-content">'+h+'</div></div>';scrollToBottom()}
function addBotMsgFb(t){messageCounter++;const id='m'+messageCounter;document.getElementById('chatMessages').innerHTML+='<div class="message bot" id="'+id+'"><div class="message-content">'+fmtMsg(t)+'<div class="feedback-bar"><button class="feedback-btn good" onclick="giveFeedback(\''+id+'\',\'good\')">ð Goed</button><button class="feedback-btn correct" onclick="giveFeedback(\''+id+'\',\'correct\')">âï¸ Corrigeer</button></div></div></div>';scrollToBottom()}
function fmtMsg(t){return escHtml(t).replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/â¬(\d+)/g,'<span class="price-tag">â¬$1</span>').replace(/\n/g,'<br>')}
function showTyping(){document.getElementById('chatMessages').innerHTML+='<div id="typing" class="message bot"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';scrollToBottom()}
function hideTyping(){document.getElementById('typing')?.remove()}
function scrollToBottom(){const m=document.getElementById('chatMessages');m.scrollTop=m.scrollHeight}
function escHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function handleFileSelect(e){Array.from(e.target.files).forEach(f=>{if(f.type.startsWith('image/')){const r=new FileReader();r.onload=ev=>{uploadedPhotos.push({data:ev.target.result,type:'chat'})};r.readAsDataURL(f)}})}

async function sendMessage(){
const input=document.getElementById('messageInput');
const msg=input.value.trim();
if(!msg&&uploadedPhotos.filter(p=>p.type==='chat').length===0)return;
if(msg)addUserMsg(msg);
input.value='';
if(!API_KEY){addBotMessage('â ï¸ Voer eerst je API key in via âï¸');return}
showTyping();
try{
const parts=[{text:'Je bent Haarvisie AI haarstylist. Vraag: '+msg}];
uploadedPhotos.filter(p=>p.type==='chat').forEach(p=>parts.push({inlineData:{mimeType:'image/jpeg',data:p.data.split(',')[1]}}));
const res=await fetch(API_URL+'?key='+API_KEY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts}],generationConfig:{temperature:0.7,maxOutputTokens:1024}})});
if(!res.ok)throw new Error('API fout');
const d=await res.json();
hideTyping();
addBotMsgFb(d.candidates[0].content.parts[0].text);
uploadedPhotos=uploadedPhotos.filter(p=>p.type!=='chat');
}catch(e){hideTyping();addBotMessage('â ï¸ '+e.message)}
}

function giveFeedback(id,type){alert('Feedback: '+type+' voor bericht '+id)}
</script>
</body>
</html>