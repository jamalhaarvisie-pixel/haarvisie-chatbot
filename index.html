<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Haarvisie AI Chatbot + Intake</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
.chat-container{width:100%;max-width:900px;height:90vh;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);display:flex;flex-direction:column;overflow:hidden}
.chat-header{background:linear-gradient(135deg,#2c3e50 0%,#4a5568 100%);color:white;padding:15px 20px;display:flex;align-items:center;gap:15px}
.logo{width:45px;height:45px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px}
.header-info h1{font-size:1.3rem;margin-bottom:2px}
.header-info p{font-size:0.8rem;opacity:0.8}
.header-buttons{margin-left:auto;display:flex;gap:8px;align-items:center}
.header-btn{padding:6px 12px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
.header-btn:hover{background:rgba(255,255,255,0.3)}
.api-status{padding:6px 12px;border-radius:15px;font-size:0.75rem;font-weight:600}
.api-status.connected{background:#48bb78}
.api-status.disconnected{background:#f56565}
.chat-messages{flex:1;overflow-y:auto;padding:20px;background:#f7fafc}
.message{max-width:85%;margin-bottom:15px;animation:fadeIn 0.3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.message.user{margin-left:auto}
.message.bot{margin-right:auto}
.message-content{padding:15px 20px;border-radius:18px;line-height:1.5}
.message.user .message-content{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-bottom-right-radius:4px}
.message.bot .message-content{background:white;color:#2d3748;border-bottom-left-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.intake-question{margin-top:15px;padding:15px;background:#f0f4ff;border-radius:12px;border-left:4px solid #667eea}
.intake-question h4{color:#4a5568;margin-bottom:10px;font-size:0.95rem}
.intake-options{display:flex;flex-wrap:wrap;gap:8px}
.intake-btn{padding:10px 16px;background:white;border:2px solid #e2e8f0;border-radius:20px;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.intake-btn:hover{border-color:#667eea;background:#f0f4ff;transform:scale(1.02)}
.intake-btn.selected{background:#667eea;color:white;border-color:#667eea}
.intake-btn.multi{border-radius:8px}
.intake-btn.multi.selected{background:#48bb78;border-color:#48bb78}
.intake-checkbox{width:18px;height:18px;border:2px solid #cbd5e0;border-radius:4px;display:flex;align-items:center;justify-content:center}
.intake-btn.selected .intake-checkbox{background:white;border-color:white}
.intake-btn.selected .intake-checkbox::after{content:'‚úì';color:#48bb78;font-weight:bold}
.intake-next{margin-top:12px;padding:12px 24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:25px;cursor:pointer;font-size:0.95rem;font-weight:600}
.intake-next:disabled{opacity:0.5;cursor:not-allowed}
.intake-next:not(:disabled):hover{transform:scale(1.02)}
.intake-progress{display:flex;gap:4px;margin-bottom:10px}
.progress-dot{width:8px;height:8px;border-radius:50%;background:#e2e8f0}
.progress-dot.active{background:#667eea}
.progress-dot.done{background:#48bb78}
.photo-upload-area{margin-top:10px;padding:20px;border:2px dashed #cbd5e0;border-radius:12px;text-align:center;cursor:pointer;transition:all 0.2s}
.photo-upload-area:hover{border-color:#667eea;background:#f0f4ff}
.photo-upload-area.has-photo{border-style:solid;border-color:#48bb78;background:#f0fff4}
.uploaded-preview{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.uploaded-preview img{width:80px;height:80px;object-fit:cover;border-radius:8px}
.chat-input-area{padding:15px 20px;background:white;border-top:1px solid #e2e8f0}
.input-row{display:flex;gap:10px;align-items:flex-end}
.input-wrapper{flex:1;position:relative}
.input-wrapper textarea{width:100%;padding:12px 45px 12px 15px;border:2px solid #e2e8f0;border-radius:20px;font-size:0.95rem;resize:none;min-height:45px;max-height:120px}
.input-wrapper textarea:focus{outline:none;border-color:#667eea}
.attach-btn{position:absolute;right:12px;bottom:10px;background:none;border:none;cursor:pointer;font-size:1.2rem;opacity:0.6}
.attach-btn:hover{opacity:1}
.send-btn{width:45px;height:45px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:50%;cursor:pointer;font-size:1.1rem}
.panel{display:none;padding:15px 20px;background:#f7fafc;border-bottom:1px solid #e2e8f0}
.panel.active{display:block}
.settings-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.settings-row input{flex:1;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;min-width:200px}
.settings-btn{padding:6px 12px;background:#667eea;color:white;border:none;border-radius:5px;cursor:pointer}
.typing-indicator{display:flex;gap:5px;padding:15px 20px;background:white;border-radius:18px;width:fit-content;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.typing-indicator span{width:8px;height:8px;background:#a0aec0;border-radius:50%;animation:typing 1.4s infinite}
.typing-indicator span:nth-child(2){animation-delay:0.2s}
.typing-indicator span:nth-child(3){animation-delay:0.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
.feedback-bar{display:flex;gap:8px;margin-top:10px}
.feedback-btn{padding:6px 12px;border:none;border-radius:15px;cursor:pointer;font-size:0.8rem;display:flex;align-items:center;gap:5px;transition:all 0.2s}
.feedback-btn.good{background:#c6f6d5;color:#22543d}
.feedback-btn.correct{background:#fed7d7;color:#822727}
#fileInput{display:none}
.price-tag{display:inline-block;background:linear-gradient(135deg,#48bb78 0%,#38a169 100%);color:white;padding:3px 10px;border-radius:12px;font-weight:600;font-size:0.85rem;margin:2px}
</style>
</head>
<body>
<div class="chat-container">
<div class="chat-header">
<div class="logo">H</div>
<div class="header-info"><h1>Haarvisie AI Assistent</h1><p>Met intake vragenlijst</p></div>
<div class="header-buttons">
<button class="header-btn" id="intakeBtn">Nieuwe Intake</button>
<button class="header-btn" id="settingsBtn">Settings</button>
<div class="api-status disconnected" id="apiStatus">Niet verbonden</div>
</div>
</div>
<div class="panel" id="settingsPanel">
<div class="settings-row">
<label>API Key:</label>
<input type="password" id="apiKeyInput" value="" placeholder="Voer je Gemini API key in">
<button class="settings-btn" id="saveKeyBtn">Activeren</button>
</div>
</div>
<div class="chat-messages" id="chatMessages">
<div class="message bot" id="welcomeMsg">
<div class="message-content">
<strong>Welkom bij Haarvisie AI!</strong><br><br>
<span id="setupPrompt" style="display:none;background:#fff3cd;padding:10px;border-radius:8px;display:block;margin-bottom:10px;">
‚ö†Ô∏è <strong>Eerst instellen:</strong> Klik op <strong>Settings</strong> en voer je Gemini API key in.<br>
<small>Verkrijg je key op: <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></small>
</span>
<span id="readyPrompt" style="display:none;">
‚úÖ AI is verbonden! Klik op <strong>Nieuwe Intake</strong> om te beginnen met de intake vragenlijst, of stel direct een vraag.
</span>
</div>
</div>
</div>
<div class="chat-input-area">
<div class="input-row">
<div class="input-wrapper">
<textarea id="messageInput" placeholder="Of stel hier direct je vraag..." rows="1"></textarea>
<button class="attach-btn" id="attachBtn">üìé</button>
</div>
<button class="send-btn" id="sendBtn">‚û§</button>
</div>
<input type="file" id="fileInput" multiple accept="image/*">
</div>
</div>

<script>
let API_KEY = localStorage.getItem('gemini_api_key') || '';
const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
let uploadedPhotos = [];
let intakeData = {};
let currentQuestion = 0;
let currentPhotoType = 'current';
let messageCounter = 0;

const INTAKE_QUESTIONS = [
    {id:'service', question:'Welke service wil je?', type:'single', options:[
        {value:'knippen', label:'‚úÇÔ∏è Knippen'},
        {value:'kleuren', label:'üé® Kleuren'},
        {value:'highlights', label:'üåü Highlights/Balayage'},
        {value:'behandeling', label:'üíÜ Behandeling'},
        {value:'styling', label:'üíÖ Styling/F√∂hnen'},
        {value:'combinatie', label:'üì¶ Combinatie'}
    ]},
    {id:'current_color', question:'Wat is je huidige haarkleur?', type:'single', options:[
        {value:'blond', label:'üë± Blond'},
        {value:'bruin', label:'ü§é Bruin'},
        {value:'zwart', label:'‚¨õ Zwart'},
        {value:'rood', label:'üî¥ Rood'},
        {value:'grijs', label:'‚¨ú Grijs/wit'},
        {value:'gekleurd', label:'üåà Fantasie kleur'}
    ]},
    {id:'colored_before', question:'Is je haar eerder gekleurd?', type:'single', options:[
        {value:'nee', label:'‚ùå Nee, natuurlijk haar'},
        {value:'ja_salon', label:'‚úÖ Ja, bij een salon'},
        {value:'ja_zelf', label:'üè† Ja, zelf thuis gekleurd'},
        {value:'ja_beide', label:'üîÑ Beide'}
    ]},
    {id:'color_history', question:'Wat is er de afgelopen 2 jaar met je haar gedaan?', type:'multi', options:[
        {value:'highlights', label:'üåü Highlights/lowlights'},
        {value:'ontkleurd', label:'‚ö° Ontkleurd/gebleekt'},
        {value:'donkerder', label:'üåë Donkerder geverfd'},
        {value:'henna', label:'üåø Henna'},
        {value:'permanent', label:'üîÑ Permanent'},
        {value:'niets', label:'‚ú® Niets'}
    ]},
    {id:'hair_condition', question:'Hoe is je haarkwaliteit?', type:'single', options:[
        {value:'gezond', label:'üí™ Gezond en sterk'},
        {value:'normaal', label:'üëç Normaal'},
        {value:'droog', label:'üèúÔ∏è Droog/pluizig'},
        {value:'beschadigd', label:'‚ö†Ô∏è Beschadigd'},
        {value:'dun', label:'ü™∂ Fijn/dun'}
    ]},
    {id:'products', question:'Welke producten gebruik je thuis?', type:'multi', options:[
        {value:'olaplex', label:'üíé Olaplex'},
        {value:'kerastase', label:'üß¥ K√©rastase'},
        {value:'andrelon', label:'üõí Supermarkt'},
        {value:'masker', label:'üé≠ Haarmaskers'},
        {value:'hittetools', label:'üî• Stijltang/f√∂hn'},
        {value:'geen', label:'‚ùå Geen speciale'}
    ]},
    {id:'photo_current', question:'üì∏ Upload een foto van je HUIDIGE haar', type:'photo', photoType:'current', description:'Maak een foto in daglicht'},
    {id:'photo_wish', question:'üéØ Upload een WENSFOTO (inspiratie)', type:'photo', photoType:'wish', description:'Upload je droomkapsel/kleur'},
    {id:'wish', question:'Beschrijf kort je wens (optioneel)', type:'text', placeholder:'Bijv: Ik wil lichter worden met een natuurlijke uitstraling...'}
];

// Initialize event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    checkApiKey();

    // Header buttons
    document.getElementById('intakeBtn').addEventListener('click', startIntake);
    document.getElementById('settingsBtn').addEventListener('click', togglePanel);
    document.getElementById('saveKeyBtn').addEventListener('click', saveApiKey);

    // Chat input
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('attachBtn').addEventListener('click', function() {
        document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
});

function checkApiKey() {
    var s = document.getElementById('apiStatus');
    var setupPrompt = document.getElementById('setupPrompt');
    var readyPrompt = document.getElementById('readyPrompt');

    if (API_KEY) {
        s.textContent = 'Verbonden';
        s.className = 'api-status connected';
        if (setupPrompt) setupPrompt.style.display = 'none';
        if (readyPrompt) readyPrompt.style.display = 'block';
    } else {
        s.textContent = 'Niet verbonden';
        s.className = 'api-status disconnected';
        if (setupPrompt) setupPrompt.style.display = 'block';
        if (readyPrompt) readyPrompt.style.display = 'none';
        // Open settings panel automatically if no API key
        document.getElementById('settingsPanel').classList.add('active');
    }
}

function togglePanel() {
    document.getElementById('settingsPanel').classList.toggle('active');
}

function saveApiKey() {
    API_KEY = document.getElementById('apiKeyInput').value.trim();
    localStorage.setItem('gemini_api_key', API_KEY);
    checkApiKey();
    togglePanel();
    addBotMessage('‚úÖ API key opgeslagen!');
}

function startIntake() {
    intakeData = {};
    currentQuestion = 0;
    uploadedPhotos = [];
    addBotMessage('üìã <strong>Intake Vragenlijst</strong><br>Beantwoord de volgende vragen zodat ik je het beste kan adviseren.');
    setTimeout(function() {
        showIntakeQuestion(currentQuestion);
    }, 500);
}

function showIntakeQuestion(qIndex) {
    if (qIndex >= INTAKE_QUESTIONS.length) {
        finishIntake();
        return;
    }

    var q = INTAKE_QUESTIONS[qIndex];
    var progressHtml = '';
    for (var i = 0; i < INTAKE_QUESTIONS.length; i++) {
        var dotClass = 'progress-dot';
        if (i < qIndex) dotClass += ' done';
        else if (i === qIndex) dotClass += ' active';
        progressHtml += '<span class="' + dotClass + '"></span>';
    }

    var content = '<div class="intake-question">';
    content += '<div class="intake-progress">' + progressHtml + '</div>';
    content += '<h4>' + q.question + '</h4>';

    if (q.description) {
        content += '<p style="font-size:0.85rem;color:#718096;margin-bottom:10px">' + q.description + '</p>';
    }

    if (q.type === 'single') {
        content += '<div class="intake-options" id="intakeOptions">';
        for (var j = 0; j < q.options.length; j++) {
            var opt = q.options[j];
            content += '<button class="intake-btn" data-qid="' + q.id + '" data-value="' + opt.value + '">' + opt.label + '</button>';
        }
        content += '</div>';
    } else if (q.type === 'multi') {
        content += '<div class="intake-options" id="intakeOptions">';
        for (var k = 0; k < q.options.length; k++) {
            var mopt = q.options[k];
            content += '<button class="intake-btn multi" data-qid="' + q.id + '" data-value="' + mopt.value + '"><span class="intake-checkbox"></span>' + mopt.label + '</button>';
        }
        content += '</div>';
        content += '<button class="intake-next" id="nextBtn" disabled>Volgende ‚Üí</button>';
    } else if (q.type === 'photo') {
        currentPhotoType = q.photoType || 'current';
        content += '<div class="photo-upload-area" id="photoArea">';
        content += '<input type="file" id="photoInput" accept="image/*" multiple style="display:none">';
        content += 'üì∑ Klik om foto te uploaden';
        content += '<div class="uploaded-preview" id="photoPreview"></div>';
        content += '</div>';
        var btnText = (q.photoType === 'wish') ? 'Overslaan / Volgende ‚Üí' : 'Volgende ‚Üí';
        content += '<button class="intake-next" id="photoNextBtn">' + btnText + '</button>';
    } else if (q.type === 'text') {
        content += '<textarea id="textInput" placeholder="' + (q.placeholder || '') + '" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:12px;min-height:80px;font-size:0.95rem;margin-top:10px"></textarea>';
        content += '<button class="intake-next" id="textNextBtn">Volgende ‚Üí</button>';
    }

    content += '</div>';
    addBotHtml(content);

    // Attach event listeners after adding to DOM
    setTimeout(function() {
        attachIntakeListeners(q);
    }, 100);
}

function attachIntakeListeners(q) {
    // Get the LAST intake-question element (the one just added)
    var allQuestions = document.querySelectorAll('.intake-question');
    var currentQuestionEl = allQuestions[allQuestions.length - 1];
    if (!currentQuestionEl) return;

    if (q.type === 'single') {
        var btns = currentQuestionEl.querySelectorAll('.intake-btn');
        btns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var qid = this.getAttribute('data-qid');
                var val = this.getAttribute('data-value');
                selectOption(qid, val, this);
            });
        });
    } else if (q.type === 'multi') {
        var mbtns = currentQuestionEl.querySelectorAll('.intake-btn');
        mbtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var qid = this.getAttribute('data-qid');
                var val = this.getAttribute('data-value');
                toggleMulti(qid, val, this);
            });
        });
        var nextBtn = currentQuestionEl.querySelector('.intake-next');
        if (nextBtn) {
            nextBtn.addEventListener('click', nextQuestion);
        }
    } else if (q.type === 'photo') {
        var photoArea = currentQuestionEl.querySelector('.photo-upload-area');
        var photoInput = currentQuestionEl.querySelector('input[type="file"]');
        if (photoArea && photoInput) {
            photoArea.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    photoInput.click();
                }
            });
            photoInput.addEventListener('change', handleIntakePhoto);
        }
        var photoNextBtn = currentQuestionEl.querySelector('.intake-next');
        if (photoNextBtn) {
            photoNextBtn.addEventListener('click', nextQuestion);
        }
    } else if (q.type === 'text') {
        var textNextBtn = currentQuestionEl.querySelector('.intake-next');
        if (textNextBtn) {
            textNextBtn.addEventListener('click', function() {
                var textInput = currentQuestionEl.querySelector('textarea');
                if (textInput) {
                    intakeData[q.id] = textInput.value;
                }
                nextQuestion();
            });
        }
    }
}

function selectOption(qid, val, btn) {
    intakeData[qid] = val;
    var allBtns = btn.parentElement.querySelectorAll('.intake-btn');
    allBtns.forEach(function(b) {
        b.classList.remove('selected');
    });
    btn.classList.add('selected');
    setTimeout(function() {
        currentQuestion++;
        showIntakeQuestion(currentQuestion);
    }, 400);
}

function toggleMulti(qid, val, btn) {
    if (!intakeData[qid]) {
        intakeData[qid] = [];
    }
    var idx = intakeData[qid].indexOf(val);
    if (idx > -1) {
        intakeData[qid].splice(idx, 1);
        btn.classList.remove('selected');
    } else {
        intakeData[qid].push(val);
        btn.classList.add('selected');
    }
    // Find the nextBtn in the same question container as the clicked button
    var questionContainer = btn.closest('.intake-question');
    if (questionContainer) {
        var nextBtn = questionContainer.querySelector('.intake-next');
        if (nextBtn) {
            nextBtn.disabled = intakeData[qid].length === 0;
        }
    }
}

function handleIntakePhoto(e) {
    var files = e.target.files;
    for (var i = 0; i < files.length; i++) {
        var f = files[i];
        if (f.type.startsWith('image/')) {
            var reader = new FileReader();
            reader.onload = function(ev) {
                uploadedPhotos.push({data: ev.target.result, type: currentPhotoType});
                updatePhotoPreview();
            };
            reader.readAsDataURL(f);
        }
    }
}

function updatePhotoPreview() {
    var photos = uploadedPhotos.filter(function(p) {
        return p.type === currentPhotoType;
    });
    // Find the last photo-upload-area (current question)
    var areas = document.querySelectorAll('.photo-upload-area');
    var area = areas[areas.length - 1];
    var preview = area ? area.querySelector('.uploaded-preview') : null;
    if (photos.length && area && preview) {
        area.classList.add('has-photo');
        var html = '‚úÖ ' + photos.length + ' foto ge√ºpload<br>';
        for (var i = 0; i < photos.length; i++) {
            html += '<img src="' + photos[i].data + '">';
        }
        preview.innerHTML = html;
    }
}

function nextQuestion() {
    currentQuestion++;
    showIntakeQuestion(currentQuestion);
}

function finishIntake() {
    addBotMessage('‚úÖ <strong>Intake compleet!</strong><br><br>Even geduld, ik analyseer je gegevens...');
    showTyping();
    generateAdvice();
}

async function generateAdvice() {
    if (!API_KEY) {
        hideTyping();
        addBotMessage('‚ö†Ô∏è Voer eerst je API key in via ‚öôÔ∏è');
        return;
    }
    try {
        var response = await callGemini();
        hideTyping();
        addBotMsgFb(response);
    } catch(e) {
        hideTyping();
        addBotMessage('‚ö†Ô∏è ' + e.message);
    }
}

async function callGemini() {
    var prompt = 'Je bent Haarvisie AI, een professionele haaradviseur. INTAKE GEGEVENS: ';
    prompt += 'Gewenste behandeling: ' + (intakeData.service || 'niet opgegeven') + ', ';
    prompt += 'Huidige kleur: ' + (intakeData.current_color || 'niet opgegeven') + ', ';
    prompt += 'Eerder gekleurd: ' + (intakeData.colored_before || 'niet opgegeven') + ', ';
    prompt += 'Kleurhistorie: ' + (intakeData.color_history ? intakeData.color_history.join(', ') : 'niet opgegeven') + ', ';
    prompt += 'Haarkwaliteit: ' + (intakeData.hair_condition || 'niet opgegeven') + ', ';
    prompt += 'Producten: ' + (intakeData.products ? intakeData.products.join(', ') : 'niet opgegeven') + ', ';
    prompt += 'Wens: ' + (intakeData.wish || 'niet opgegeven') + '. ';
    prompt += 'PRIJZEN: Highlights vanaf ‚Ç¨325, Balayage vanaf ‚Ç¨185, Kleuren vanaf ‚Ç¨95, Full colour ‚Ç¨175. ';
    prompt += 'Analyseer de foto van het huidige haar en vergelijk met de wensfoto (indien aanwezig). ';
    prompt += 'Geef een persoonlijk advies, geschatte prijs en waarschuw bij risicos. Wees vriendelijk en professioneel.';

    var parts = [{text: prompt}];

    // Add current hair photos
    var currentPhotos = uploadedPhotos.filter(function(p) { return p.type === 'current'; });
    for (var i = 0; i < currentPhotos.length; i++) {
        var imgData = currentPhotos[i].data.split(',')[1];
        parts.push({inlineData: {mimeType: 'image/jpeg', data: imgData}});
    }

    // Add wish photos
    var wishPhotos = uploadedPhotos.filter(function(p) { return p.type === 'wish'; });
    for (var j = 0; j < wishPhotos.length; j++) {
        var wishData = wishPhotos[j].data.split(',')[1];
        parts.push({inlineData: {mimeType: 'image/jpeg', data: wishData}});
    }

    var response = await fetch(API_URL + '?key=' + API_KEY, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            contents: [{parts: parts}],
            generationConfig: {temperature: 0.7, maxOutputTokens: 1024}
        })
    });

    if (!response.ok) {
        throw new Error('API fout: ' + response.status);
    }

    var data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

function addUserMsg(text) {
    var html = '<div class="message user"><div class="message-content">' + escHtml(text) + '</div></div>';
    document.getElementById('chatMessages').innerHTML += html;
    scrollToBottom();
}

function addBotMessage(text) {
    var html = '<div class="message bot"><div class="message-content">' + text + '</div></div>';
    document.getElementById('chatMessages').innerHTML += html;
    scrollToBottom();
}

function addBotHtml(html) {
    var wrapper = '<div class="message bot"><div class="message-content">' + html + '</div></div>';
    document.getElementById('chatMessages').innerHTML += wrapper;
    scrollToBottom();
}

function addBotMsgFb(text) {
    messageCounter++;
    var id = 'msg_' + messageCounter;
    var html = '<div class="message bot" id="' + id + '"><div class="message-content">' + formatMessage(text);
    html += '<div class="feedback-bar">';
    html += '<button class="feedback-btn good" data-msgid="' + id + '" data-type="good">üëç Goed</button>';
    html += '<button class="feedback-btn correct" data-msgid="' + id + '" data-type="correct">‚úèÔ∏è Corrigeer</button>';
    html += '</div></div></div>';
    document.getElementById('chatMessages').innerHTML += html;
    scrollToBottom();

    // Attach feedback listeners
    setTimeout(function() {
        var feedbackBtns = document.querySelectorAll('#' + id + ' .feedback-btn');
        feedbackBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var msgId = this.getAttribute('data-msgid');
                var type = this.getAttribute('data-type');
                giveFeedback(msgId, type);
            });
        });
    }, 100);
}

function formatMessage(text) {
    var formatted = escHtml(text);
    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    formatted = formatted.replace(/‚Ç¨(\d+)/g, '<span class="price-tag">‚Ç¨$1</span>');
    formatted = formatted.replace(/\n/g, '<br>');
    return formatted;
}

function showTyping() {
    var html = '<div id="typing" class="message bot"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
    document.getElementById('chatMessages').innerHTML += html;
    scrollToBottom();
}

function hideTyping() {
    var typing = document.getElementById('typing');
    if (typing) {
        typing.remove();
    }
}

function scrollToBottom() {
    var msgs = document.getElementById('chatMessages');
    msgs.scrollTop = msgs.scrollHeight;
}

function escHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function handleFileSelect(e) {
    var files = e.target.files;
    for (var i = 0; i < files.length; i++) {
        var f = files[i];
        if (f.type.startsWith('image/')) {
            var reader = new FileReader();
            reader.onload = function(ev) {
                uploadedPhotos.push({data: ev.target.result, type: 'chat'});
            };
            reader.readAsDataURL(f);
        }
    }
}

async function sendMessage() {
    var input = document.getElementById('messageInput');
    var msg = input.value.trim();
    var chatPhotos = uploadedPhotos.filter(function(p) { return p.type === 'chat'; });

    if (!msg && chatPhotos.length === 0) {
        return;
    }

    if (msg) {
        addUserMsg(msg);
    }
    input.value = '';

    if (!API_KEY) {
        addBotMessage('‚ö†Ô∏è Voer eerst je API key in via ‚öôÔ∏è');
        return;
    }

    showTyping();

    try {
        var parts = [{text: 'Je bent Haarvisie AI, een vriendelijke haaradviseur. Vraag: ' + msg}];

        for (var i = 0; i < chatPhotos.length; i++) {
            var imgData = chatPhotos[i].data.split(',')[1];
            parts.push({inlineData: {mimeType: 'image/jpeg', data: imgData}});
        }

        var response = await fetch(API_URL + '?key=' + API_KEY, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{parts: parts}],
                generationConfig: {temperature: 0.7, maxOutputTokens: 1024}
            })
        });

        if (!response.ok) {
            throw new Error('API fout: ' + response.status);
        }

        var data = await response.json();
        hideTyping();
        addBotMsgFb(data.candidates[0].content.parts[0].text);

        // Clear chat photos after sending
        uploadedPhotos = uploadedPhotos.filter(function(p) { return p.type !== 'chat'; });

    } catch(e) {
        hideTyping();
        addBotMessage('‚ö†Ô∏è ' + e.message);
    }
}

function giveFeedback(msgId, type) {
    alert('Bedankt voor je feedback! Type: ' + type);
}
</script>
</body>
</html>
