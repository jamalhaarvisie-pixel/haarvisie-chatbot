<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haarvisie AI Chatbot + Intake</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .chat-container { width: 100%; max-width: 900px; height: 90vh; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { background: linear-gradient(135deg, #2c3e50 0%, #4a5568 100%); color: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; }
        .logo { width: 45px; height: 45px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .header-info h1 { font-size: 1.3rem; } .header-info p { font-size: 0.8rem; opacity: 0.8; }
        .header-buttons { margin-left: auto; display: flex; gap: 8px; }
        .header-btn { padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .api-status { padding: 6px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; }
        .api-status.connected { background: #48bb78; } .api-status.disconnected { background: #f56565; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f7fafc; }
        .message { max-width: 85%; margin-bottom: 15px; }
        .message.user { margin-left: auto; } .message.bot { margin-right: auto; }
        .message-content { padding: 15px 20px; border-radius: 18px; line-height: 1.5; }
        .message.user .message-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .message.bot .message-content { background: white; color: #2d3748; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .intake-question { margin-top: 15px; padding: 15px; background: #f0f4ff; border-radius: 12px; border-left: 4px solid #667eea; }
        .intake-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .intake-btn { padding: 10px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 20px; cursor: pointer; }
        .intake-btn.selected { background: #667eea; color: white; }
        .intake-btn.multi.selected { background: #48bb78; }
        .intake-next { margin-top: 12px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; cursor: pointer; }
        .photo-upload-area { margin-top: 10px; padding: 20px; border: 2px dashed #cbd5e0; border-radius: 12px; text-align: center; cursor: pointer; }
        .photo-upload-area.has-photo { border-color: #48bb78; background: #f0fff4; }
        .uploaded-preview { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .uploaded-preview img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .chat-input-area { padding: 15px 20px; background: white; border-top: 1px solid #e2e8f0; }
        .input-row { display: flex; gap: 10px; }
        .input-wrapper { flex: 1; position: relative; }
        .input-wrapper textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 20px; }
        .send-btn { width: 45px; height: 45px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; cursor: pointer; }
        .panel { display: none; padding: 15px 20px; background: #f7fafc; } .panel.active { display: block; }
        .settings-row { display: flex; gap: 10px; }
        .settings-row input { flex: 1; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; }
        .settings-btn { padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .price-tag { background: #48bb78; color: white; padding: 3px 10px; border-radius: 12px; }
        .typing-indicator { display: flex; gap: 5px; padding: 15px; background: white; border-radius: 18px; }
        .typing-indicator span { width: 8px; height: 8px; background: #a0aec0; border-radius: 50%; animation: typing 1.4s infinite; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }
        .feedback-bar { display: flex; gap: 8px; margin-top: 10px; }
        .feedback-btn { padding: 6px 12px; border: none; border-radius: 15px; cursor: pointer; }
        .feedback-btn.good { background: #c6f6d5; } .feedback-btn.correct { background: #fed7d7; }
        #fileInput { display: none; }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <div class="logo">üíá</div>
        <div class="header-info"><h1>Haarvisie AI Assistent</h1><p>Met intake vragenlijst</p></div>
        <div class="header-buttons">
            <button class="header-btn" onclick="startIntake()">üìã Nieuwe Intake</button>
            <button class="header-btn" onclick="togglePanel()">‚öôÔ∏è</button>
            <div class="api-status disconnected" id="apiStatus">Niet verbonden</div>
        </div>
    </div>
    <div class="panel" id="settingsPanel"><div class="settings-row"><label>API Key:</label><input type="password" id="apiKeyInput" placeholder="Voer je Gemini API key in"><button class="settings-btn" onclick="saveApiKey()">Opslaan</button></div></div>
    <div class="chat-messages" id="chatMessages"><div class="message bot"><div class="message-content"><strong>Welkom bij Haarvisie! üëã</strong><br><br>Klik op "üìã Nieuwe Intake" om te beginnen!</div></div></div>
    <div class="chat-input-area"><div class="input-row"><div class="input-wrapper"><textarea id="messageInput" placeholder="Stel je vraag..." rows="1"></textarea></div><button class="send-btn" onclick="sendMessage()">‚û§</button></div><input type="file" id="fileInput" multiple accept="image/*" onchange="handleFileSelect(event)"></div>
</div>
<script>
___FUNCTIONS_GO_HERE___
</script>
</body>
</html>let API_KEY = localStorage.getItem('gemini_api_key') || '';
const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
let uploadedPhotos = [], intakeData = {}, currentQuestion = 0, messageCounter = 0, currentPhotoType = 'current';

const INTAKE_QUESTIONS = [
    {id:'service',question:'Welke behandeling wil je?',type:'single',options:[{value:'highlights',label:'üí° Highlights'},{value:'balayage',label:'üé® Balayage'},{value:'full_color',label:'üñåÔ∏è Volledige kleuring'},{value:'grijs_dekken',label:'üîò Grijs dekken'},{value:'toner',label:'‚ú® Toner/Gloss'},{value:'anders',label:'‚ùì Iets anders'}]},
    {id:'current_color',question:'Wat is je huidige haarkleur?',type:'single',options:[{value:'blond',label:'üë± Blond'},{value:'lichtbruin',label:'üü§ Lichtbruin'},{value:'donkerbruin',label:'üü´ Donkerbruin'},{value:'zwart',label:'‚¨õ Zwart'},{value:'rood',label:'üî¥ Rood/koper'},{value:'grijs',label:'‚ö™ Grijs/wit'}]},
    {id:'colored_before',question:'Is je haar eerder gekleurd?',type:'single',options:[{value:'nee',label:'‚ùå Nee, natuurlijk'},{value:'ja_salon',label:'‚úÖ Ja, salon'},{value:'ja_zelf',label:'üè† Ja, thuis'},{value:'ja_beide',label:'üîÑ Beide'}]},
    {id:'color_history',question:'Wat is er de afgelopen 2 jaar gedaan?',type:'multi',options:[{value:'highlights',label:'üí° Highlights'},{value:'ontkleurd',label:'‚ö° Gebleekt'},{value:'donkerder',label:'üåë Donkerder'},{value:'henna',label:'üåø Henna'},{value:'permanent',label:'üíà Permanent'},{value:'niets',label:'‚ú® Niets'}]},
    {id:'hair_condition',question:'Hoe is je haarkwaliteit?',type:'single',options:[{value:'gezond',label:'üí™ Gezond'},{value:'normaal',label:'üëç Normaal'},{value:'droog',label:'üèúÔ∏è Droog'},{value:'beschadigd',label:'‚ö†Ô∏è Beschadigd'},{value:'dun',label:'ü™∂ Fijn'}]},
    {id:'products',question:'Welke producten gebruik je?',type:'multi',options:[{value:'olaplex',label:'üíú Olaplex'},{value:'kerastase',label:'üß¥ K√©rastase'},{value:'andrelon',label:'üõí Supermarkt'},{value:'masker',label:'üé≠ Maskers'},{value:'hittetools',label:'üî• Hittetools'},{value:'geen',label:'‚ùå Geen'}]},
    {id:'photo_current',question:'Upload foto van je HUIDIGE haar',type:'photo',photoType:'current',description:'Maak een foto in daglicht'},
    {id:'photo_wish',question:'Upload een WENSFOTO (inspiratie)',type:'photo',photoType:'wish',description:'Upload je inspiratiefoto'},
    {id:'wish',question:'Beschrijf je wens (optioneel)',type:'text',placeholder:'Bijv: Ik wil lichter worden...'}
];

document.addEventListener('DOMContentLoaded',()=>checkApiKey());
function checkApiKey(){const s=document.getElementById('apiStatus');s.textContent=API_KEY?'Verbonden':'Niet verbonden';s.className='api-status '+(API_KEY?'connected':'disconnected');}
function togglePanel(){document.getElementById('settingsPanel').classList.toggle('active');}
function saveApiKey(){API_KEY=document.getElementById('apiKeyInput').value.trim();localStorage.setItem('gemini_api_key',API_KEY);checkApiKey();togglePanel();addBotMessage('‚úÖ API key opgeslagen!');}
function startIntake(){intakeData={};currentQuestion=0;uploadedPhotos=[];addBotMessage('üìã <strong>Laten we beginnen!</strong><br>Beantwoord de vragen door te klikken.');setTimeout(()=>showIntakeQuestion(0),500);}
function setPhotoType(t){currentPhotoType=t;}

function showIntakeQuestion(idx){
    if(idx>=INTAKE_QUESTIONS.length){finishIntake();return;}
    currentQuestion=idx;const q=INTAKE_QUESTIONS[idx];
    let h='<div class="message bot"><div class="message-content"><div class="intake-question">';
    h+='<h4>Vraag '+(idx+1)+'/'+INTAKE_QUESTIONS.length+': '+q.question+'</h4>';
    if(q.type==='single'||q.type==='multi'){
        h+='<div class="intake-options" id="opt-'+q.id+'">';
        q.options.forEach(o=>{h+='<button class="intake-btn'+(q.type==='multi'?' multi':'')+'" data-v="'+o.value+'" onclick="selectOpt(''+q.id+'',''+o.value+'',''+q.type+'',this)">'+o.label+'</button>';});
        h+='</div>';if(q.type==='multi')h+='<button class="intake-next" onclick="nextQ()">Volgende ‚Üí</button>';
    }else if(q.type==='photo'){
        h+='<p style="color:#718096;font-size:0.85rem">'+q.description+'</p>';
        h+='<div class="photo-upload-area" id="photoArea" onclick="setPhotoType(''+q.photoType+'');document.getElementById('intakeFile').click()">üì∑ Klik om foto te uploaden</div>';
        h+='<div class="uploaded-preview" id="preview"></div><input type="file" id="intakeFile" accept="image/*" onchange="handlePhoto(event)" style="display:none">';
        h+='<button class="intake-next" onclick="nextQ()">Volgende ‚Üí</button>';
        if(q.photoType==='wish')h+='<button class="intake-next" style="background:#a0aec0;margin-left:10px" onclick="nextQ()">Overslaan ‚Üí</button>';
    }else if(q.type==='text'){
        h+='<textarea id="txt-'+q.id+'" placeholder="'+q.placeholder+'" style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:8px;min-height:80px"></textarea>';
        h+='<button class="intake-next" onclick="saveTxt(''+q.id+'')">Verstuur ‚Üí</button>';
    }
    h+='</div></div></div>';
    document.getElementById('chatMessages').innerHTML+=h;scrollToBottom();
}

function selectOpt(qid,val,type,btn){
    if(type==='single'){document.querySelectorAll('#opt-'+qid+' .intake-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');intakeData[qid]=val;setTimeout(nextQ,400);}
    else{btn.classList.toggle('selected');intakeData[qid]=Array.from(document.querySelectorAll('#opt-'+qid+' .intake-btn.selected')).map(b=>b.dataset.v);}
}

function handlePhoto(e){
    Array.from(e.target.files).forEach(f=>{if(f.type.startsWith('image/')){const r=new FileReader();r.onload=ev=>{uploadedPhotos.push({data:ev.target.result,type:currentPhotoType});updatePreview();};r.readAsDataURL(f);}});
}

function updatePreview(){
    const photos=uploadedPhotos.filter(p=>p.type===currentPhotoType);
    if(photos.length){document.getElementById('photoArea').className='photo-upload-area has-photo';document.getElementById('photoArea').innerHTML='‚úÖ '+photos.length+' foto ge√ºpload';document.getElementById('preview').innerHTML=photos.map(p=>'<img src="'+p.data+'">').join('');}
}

function saveTxt(qid){intakeData[qid]=document.getElementById('txt-'+qid).value;nextQ();}
function nextQ(){const pq=INTAKE_QUESTIONS[currentQuestion];let ans=intakeData[pq.id];if(pq.type==='photo'){const ph=uploadedPhotos.filter(p=>p.type===pq.photoType);ans=ph.length?'‚úÖ '+ph.length+' foto':'Geen foto';}if(ans)addUserMsg(Array.isArray(ans)?ans.join(', '):ans);currentQuestion++;setTimeout(()=>showIntakeQuestion(currentQuestion),300);}

function finishIntake(){addBotMessage('‚úÖ <strong>Intake compleet!</strong><br>Even geduld...');showTyping();generateAdvice();}

async function generateAdvice(){
    if(!API_KEY){hideTyping();addBotMessage('‚ö†Ô∏è Voer eerst je API key in via ‚öôÔ∏è');return;}
    try{const r=await callGemini();hideTyping();addBotMsgFb(r);}catch(e){hideTyping();addBotMessage('‚ö†Ô∏è '+e.message);}
}

async function callGemini(){
    const prompt='Je bent Haarvisie AI. INTAKE: Behandeling:'+intakeData.service+', Kleur:'+intakeData.current_color+', Gekleurd:'+intakeData.colored_before+', Conditie:'+intakeData.hair_condition+', Wens:'+intakeData.wish+'. PRIJZEN: Highlights ‚Ç¨325, Balayage ‚Ç¨295, Uitgroei ‚Ç¨95, Kleuring ‚Ç¨175. Geef advies, prijs en waarschuw bij risicos.';
    const parts=[{text:prompt}];
    uploadedPhotos.filter(p=>p.type==='current').forEach(p=>parts.push({inlineData:{mimeType:'image/jpeg',data:p.data.split(',')[1]}}));
    uploadedPhotos.filter(p=>p.type==='wish').forEach(p=>parts.push({inlineData:{mimeType:'image/jpeg',data:p.data.split(',')[1]}}));
    const res=await fetch(API_URL+'?key='+API_KEY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts}],generationConfig:{temperature:0.7,maxOutputTokens:2048}})});
    if(!res.ok)throw new Error('API fout');const d=await res.json();return d.candidates[0].content.parts[0].text;
}

function addUserMsg(t){document.getElementById('chatMessages').innerHTML+='<div class="message user"><div class="message-content">'+escHtml(t)+'</div></div>';scrollToBottom();}
function addBotMessage(t){document.getElementById('chatMessages').innerHTML+='<div class="message bot"><div class="message-content">'+t+'</div></div>';scrollToBottom();}
function addBotMsgFb(t){messageCounter++;const id='m'+messageCounter;document.getElementById('chatMessages').innerHTML+='<div class="message bot" id="'+id+'"><div class="message-content">'+fmtMsg(t)+'</div><div class="feedback-bar"><button class="feedback-btn good" onclick="this.parentElement.innerHTML='‚úÖ Bedankt!'">‚úÖ Goed</button></div></div>';scrollToBottom();}
function fmtMsg(t){return escHtml(t).replace(/**(.*?)**/g,'<strong>$1</strong>').replace(/‚Ç¨(d+)/g,'<span class="price-tag">‚Ç¨$1</span>').replace(/
/g,'<br>');}
function showTyping(){document.getElementById('chatMessages').innerHTML+='<div id="typing" class="message bot"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';scrollToBottom();}
function hideTyping(){document.getElementById('typing')?.remove();}
function scrollToBottom(){const m=document.getElementById('chatMessages');m.scrollTop=m.scrollHeight;}
function escHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function handleFileSelect(e){Array.from(e.target.files).forEach(f=>{if(f.type.startsWith('image/')){const r=new FileReader();r.onload=ev=>uploadedPhotos.push({data:ev.target.result});r.readAsDataURL(f);}});}
async function sendMessage(){const i=document.getElementById('messageInput'),m=i.value.trim();if(!m)return;addUserMsg(m);i.value='';showTyping();try{const r=await fetch(API_URL+'?key='+API_KEY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:'Je bent Haarvisie AI. Vraag: '+m}]}],generationConfig:{temperature:0.7,maxOutputTokens:1024}})});if(!r.ok)throw new Error('API fout');const d=await r.json();hideTyping();addBotMsgFb(d.candidates[0].content.parts[0].text);}catch(e){hideTyping();addBotMessage('‚ö†Ô∏è '+e.message);}}
