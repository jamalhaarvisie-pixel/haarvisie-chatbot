<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Haarvisie Intake</title>
    <style>
        /* ========================================
           RESET & BASE (Mobile First)
           ======================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.5;
        }

        /* ========================================
           LAYOUT
           ======================================== */
        .app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
        }

        /* ========================================
           HEADER
           ======================================== */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
        }

        .header-title {
            flex: 1;
        }

        .header-title h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .header-title p {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f56565;
        }

        .status-dot.connected {
            background: #48bb78;
        }

        /* ========================================
           SETTINGS PANEL
           ======================================== */
        .settings {
            background: #fff;
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: none;
        }

        .settings.active {
            display: block;
        }

        .settings-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .settings-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95rem;
        }

        .settings-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .settings-save {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ========================================
           CHAT AREA
           ======================================== */
        .chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* ========================================
           MESSAGES
           ======================================== */
        .msg {
            max-width: 90%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg.bot {
            align-self: flex-start;
        }

        .msg.user {
            align-self: flex-end;
        }

        .msg-content {
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 0.95rem;
        }

        .msg.bot .msg-content {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-bottom-left-radius: 4px;
        }

        .msg.user .msg-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* ========================================
           INTAKE CARD
           ======================================== */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            animation: slideIn 0.3s ease;
        }

        .card-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 0.85rem;
            color: #718096;
        }

        .progress-dots {
            display: flex;
            gap: 4px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: all 0.3s;
        }

        .progress-dot.done {
            background: #48bb78;
        }

        .progress-dot.active {
            background: #667eea;
            transform: scale(1.3);
        }

        .card-question {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .card-hint {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 16px;
        }

        /* ========================================
           OPTIONS
           ======================================== */
        .options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .opt-btn {
            padding: 14px 18px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
        }

        .opt-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .opt-btn.selected {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .opt-btn.multi {
            border-radius: 10px;
        }

        .opt-btn.multi.selected {
            background: #48bb78;
            border-color: #48bb78;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .opt-btn.selected .checkbox {
            background: white;
            border-color: white;
            color: #48bb78;
        }

        /* ========================================
           ACTION BUTTONS
           ======================================== */
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 48px;
        }

        .btn-back {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-back:hover {
            background: #e2e8f0;
        }

        .btn-next {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-next:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-next:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* ========================================
           PHOTO UPLOAD
           ======================================== */
        .photo-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-area:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .photo-area.has-photo {
            border-style: solid;
            border-color: #48bb78;
            background: #f0fff4;
        }

        .photo-area input {
            display: none;
        }

        .photo-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .photo-preview {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
        }

        .photo-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        /* ========================================
           TEXT INPUT
           ======================================== */
        .text-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            min-height: 100px;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ========================================
           TYPING INDICATOR
           ======================================== */
        .typing {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-width: 200px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #a0aec0;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .typing-text {
            font-size: 0.85rem;
            color: #718096;
        }

        /* ========================================
           RESULT CARD
           ======================================== */
        .result {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .result h3 {
            color: #1a202c;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-content {
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .result-content strong {
            color: #667eea;
        }

        .price-tag {
            display: inline-block;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn-feedback {
            padding: 10px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-feedback.good {
            background: #c6f6d5;
            color: #22543d;
        }

        .btn-feedback.question {
            background: #e9d8fd;
            color: #553c9a;
        }

        /* ========================================
           INPUT BAR (for follow-up questions)
           ======================================== */
        .input-bar {
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .input-bar input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            font-size: 0.95rem;
        }

        .input-bar input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-bar button {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* ========================================
           WELCOME
           ======================================== */
        .welcome {
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .welcome h2 {
            font-size: 1.3rem;
            margin-bottom: 8px;
        }

        .welcome p {
            color: #718096;
            margin-bottom: 24px;
        }

        .btn-start {
            padding: 16px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        /* ========================================
           ERROR
           ======================================== */
        .error {
            background: #fed7d7;
            color: #822727;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        /* ========================================
           DESKTOP
           ======================================== */
        @media (min-width: 600px) {
            body {
                padding: 20px;
            }

            .app {
                min-height: calc(100vh - 40px);
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                overflow: hidden;
            }
        }

        /* ========================================
           UTILITY
           ======================================== */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="app">
        <!-- HEADER -->
        <header class="header">
            <div class="header-logo">H</div>
            <div class="header-title">
                <h1>Haarvisie</h1>
                <p>Persoonlijk haaradvies</p>
            </div>
            <button class="header-btn" id="settingsBtn" title="Instellingen">‚öôÔ∏è</button>
            <div class="status-dot" id="statusDot" title="API Status"></div>
        </header>

        <!-- SETTINGS -->
        <div class="settings" id="settingsPanel">
            <div class="settings-row">
                <input type="password" class="settings-input" id="apiKeyInput" placeholder="Voer je API key in">
                <button class="settings-save" id="saveKeyBtn">Opslaan</button>
            </div>
        </div>

        <!-- CHAT -->
        <main class="chat" id="chat">
            <!-- Content wordt dynamisch gegenereerd -->
        </main>

        <!-- INPUT BAR (hidden by default, shown after advice) -->
        <div class="input-bar hidden" id="inputBar">
            <input type="text" id="followUpInput" placeholder="Stel een vervolgvraag...">
            <button id="sendBtn">‚û§</button>
        </div>
    </div>

<script>
// ============================================
// HAARVISIE CHATBOT - CLEAN REBUILD
// ============================================

// ============================================
// CONFIG
// ============================================
const CONFIG = {
    API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
    STORAGE_KEY: 'haarvisie_api_key'
};

const QUESTIONS = [
    {
        id: 'service',
        question: 'Wat wil je laten doen?',
        hint: 'Kies de behandeling die je zoekt',
        type: 'single',
        options: [
            { value: 'knippen', label: '‚úÇÔ∏è Knippen' },
            { value: 'kleuren', label: 'üé® Kleuren' },
            { value: 'highlights', label: 'üåü Highlights / Balayage' },
            { value: 'behandeling', label: 'üíÜ Behandeling' },
            { value: 'styling', label: 'üíÖ Styling' },
            { value: 'combinatie', label: 'üì¶ Meerdere behandelingen' }
        ]
    },
    {
        id: 'photo_current',
        question: 'Heb je een foto van je huidige haar?',
        hint: 'Optioneel - helpt voor beter advies',
        type: 'photo',
        photoType: 'current',
        optional: true
    },
    {
        id: 'current_color',
        question: 'Wat is je huidige haarkleur?',
        type: 'single',
        options: [
            { value: 'blond', label: 'üë± Blond' },
            { value: 'bruin', label: 'ü§é Bruin' },
            { value: 'zwart', label: '‚¨õ Zwart' },
            { value: 'rood', label: 'üî¥ Rood' },
            { value: 'grijs', label: '‚¨ú Grijs / Wit' },
            { value: 'gekleurd', label: 'üåà Fantasiekleur' }
        ]
    },
    {
        id: 'colored_before',
        question: 'Is je haar eerder geverfd?',
        type: 'single',
        options: [
            { value: 'nee', label: '‚ùå Nee, nooit' },
            { value: 'salon', label: 'üíá Ja, bij de kapper' },
            { value: 'thuis', label: 'üè† Ja, thuis' },
            { value: 'beide', label: 'üîÑ Beide' }
        ]
    },
    {
        id: 'color_history',
        question: 'Wat is er de afgelopen 2 jaar gedaan?',
        hint: 'Selecteer alles wat van toepassing is',
        type: 'multi',
        skipIf: { questionId: 'colored_before', value: 'nee' },
        options: [
            { value: 'highlights', label: 'üåü Highlights' },
            { value: 'gebleekt', label: '‚ö° Gebleekt' },
            { value: 'donkerder', label: 'üåë Donkerder geverfd' },
            { value: 'henna', label: 'üåø Henna' },
            { value: 'permanent', label: 'üîÑ Permanent' }
        ]
    },
    {
        id: 'hair_condition',
        question: 'Hoe voelt je haar?',
        type: 'single',
        options: [
            { value: 'gezond', label: 'üí™ Gezond & sterk' },
            { value: 'normaal', label: 'üëç Normaal' },
            { value: 'droog', label: 'üèúÔ∏è Droog / Pluizig' },
            { value: 'beschadigd', label: '‚ö†Ô∏è Beschadigd' },
            { value: 'fijn', label: 'ü™∂ Fijn / Dun' }
        ]
    },
    {
        id: 'products',
        question: 'Welke producten gebruik je thuis?',
        hint: 'Selecteer alles wat van toepassing is',
        type: 'multi',
        options: [
            { value: 'olaplex', label: 'üíé Olaplex' },
            { value: 'kerastase', label: 'üß¥ K√©rastase' },
            { value: 'supermarkt', label: 'üõí Supermarkt' },
            { value: 'maskers', label: 'üé≠ Haarmaskers' },
            { value: 'hittetools', label: 'üî• Stijltang/f√∂hn' },
            { value: 'geen', label: '‚ùå Geen speciale' }
        ]
    },
    {
        id: 'photo_wish',
        question: 'Heb je een inspiratiefoto?',
        hint: 'Optioneel - laat je droomkapsel zien',
        type: 'photo',
        photoType: 'wish',
        optional: true
    },
    {
        id: 'extra_wish',
        question: 'Wil je nog iets toevoegen?',
        hint: 'Optioneel - beschrijf je wens of stel een vraag',
        type: 'text',
        optional: true,
        placeholder: 'Bijv: Ik wil lichter worden maar wel natuurlijk...'
    }
];

// ============================================
// STATE
// ============================================
const STATE = {
    apiKey: localStorage.getItem(CONFIG.STORAGE_KEY) || '',
    currentStep: -1, // -1 = welcome, 0+ = questions
    answers: {},
    photos: { current: null, wish: null },
    isTransitioning: false,
    skippedQuestions: []
};

// ============================================
// DOM ELEMENTS
// ============================================
const $ = id => document.getElementById(id);
const chat = $('chat');
const settingsPanel = $('settingsPanel');
const apiKeyInput = $('apiKeyInput');
const statusDot = $('statusDot');
const inputBar = $('inputBar');

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', init);

function init() {
    updateApiStatus();
    showWelcome();
    setupEventListeners();
}

function setupEventListeners() {
    // Settings
    $('settingsBtn').onclick = toggleSettings;
    $('saveKeyBtn').onclick = saveApiKey;

    // Event delegation for chat
    chat.onclick = handleChatClick;

    // Follow-up input
    $('sendBtn').onclick = sendFollowUp;
    $('followUpInput').onkeydown = e => {
        if (e.key === 'Enter') sendFollowUp();
    };
}

// ============================================
// API KEY MANAGEMENT
// ============================================
function updateApiStatus() {
    if (STATE.apiKey && STATE.apiKey.length > 10) {
        statusDot.classList.add('connected');
        statusDot.title = 'Verbonden';
        settingsPanel.classList.remove('active');
        // Show masked key
        apiKeyInput.value = maskKey(STATE.apiKey);
    } else {
        statusDot.classList.remove('connected');
        statusDot.title = 'Niet verbonden';
        settingsPanel.classList.add('active');
    }
}

function maskKey(key) {
    if (!key || key.length < 10) return '';
    return key.slice(0, 6) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.slice(-4);
}

function toggleSettings() {
    settingsPanel.classList.toggle('active');
    if (settingsPanel.classList.contains('active')) {
        apiKeyInput.value = STATE.apiKey ? maskKey(STATE.apiKey) : '';
        apiKeyInput.focus();
    }
}

function saveApiKey() {
    const key = apiKeyInput.value.trim();

    // Don't save masked key
    if (key.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
        settingsPanel.classList.remove('active');
        return;
    }

    if (key && key.length > 20) {
        STATE.apiKey = key;
        localStorage.setItem(CONFIG.STORAGE_KEY, key);
        updateApiStatus();
        addMessage('bot', '‚úÖ API key opgeslagen! Je kunt nu starten.');
    } else {
        addMessage('bot', '‚ö†Ô∏è Voer een geldige API key in.');
    }
}

// ============================================
// WELCOME SCREEN
// ============================================
function showWelcome() {
    chat.innerHTML = `
        <div class="welcome">
            <div class="welcome-icon">üíá</div>
            <h2>Welkom bij Haarvisie!</h2>
            <p>Beantwoord een paar vragen en ontvang persoonlijk haaradvies van onze AI.</p>
            <button class="btn-start" data-action="start">üéØ Start Intake</button>
        </div>
    `;
}

// ============================================
// EVENT DELEGATION
// ============================================
function handleChatClick(e) {
    if (STATE.isTransitioning) return;

    const target = e.target;
    const action = target.dataset.action;
    const optBtn = target.closest('.opt-btn');
    const nextBtn = target.closest('.btn-next');
    const backBtn = target.closest('.btn-back');
    const photoArea = target.closest('.photo-area');

    // Start intake
    if (action === 'start') {
        if (!STATE.apiKey) {
            addMessage('bot', '‚ö†Ô∏è Voer eerst je API key in via ‚öôÔ∏è');
            settingsPanel.classList.add('active');
            return;
        }
        startIntake();
        return;
    }

    // Single select option
    if (optBtn && !optBtn.classList.contains('multi')) {
        e.preventDefault();
        const qid = optBtn.dataset.qid;
        const val = optBtn.dataset.value;
        handleSingleSelect(qid, val, optBtn);
        return;
    }

    // Multi select option
    if (optBtn && optBtn.classList.contains('multi')) {
        e.preventDefault();
        const qid = optBtn.dataset.qid;
        const val = optBtn.dataset.value;
        handleMultiSelect(qid, val, optBtn);
        return;
    }

    // Next button
    if (nextBtn && !nextBtn.disabled) {
        e.preventDefault();
        goNext();
        return;
    }

    // Back button
    if (backBtn) {
        e.preventDefault();
        goBack();
        return;
    }

    // Photo area
    if (photoArea) {
        const input = photoArea.querySelector('input');
        if (input && target !== input) {
            input.click();
        }
        return;
    }

    // Feedback buttons
    if (action === 'feedback-good') {
        addMessage('bot', 'üòä Fijn dat het advies nuttig was!');
        return;
    }
    if (action === 'feedback-question') {
        inputBar.classList.remove('hidden');
        $('followUpInput').focus();
        return;
    }

    // New intake
    if (action === 'new-intake') {
        resetIntake();
        startIntake();
        return;
    }
}

// ============================================
// INTAKE FLOW
// ============================================
function startIntake() {
    STATE.currentStep = 0;
    STATE.answers = {};
    STATE.photos = { current: null, wish: null };
    STATE.skippedQuestions = [];
    inputBar.classList.add('hidden');

    addMessage('bot', 'üìã Laten we beginnen! Beantwoord de vragen zodat ik je het beste kan adviseren.');

    setTimeout(() => showQuestion(0), 400);
}

function resetIntake() {
    STATE.currentStep = -1;
    STATE.answers = {};
    STATE.photos = { current: null, wish: null };
    STATE.skippedQuestions = [];
}

function getVisibleQuestions() {
    return QUESTIONS.filter(q => {
        if (q.skipIf) {
            const answer = STATE.answers[q.skipIf.questionId];
            if (answer === q.skipIf.value) return false;
        }
        return true;
    });
}

function showQuestion(index) {
    const visibleQuestions = getVisibleQuestions();

    if (index >= visibleQuestions.length) {
        finishIntake();
        return;
    }

    STATE.currentStep = index;
    const q = visibleQuestions[index];
    const total = visibleQuestions.length;

    // Build progress
    let progressDots = '';
    for (let i = 0; i < total; i++) {
        let cls = 'progress-dot';
        if (i < index) cls += ' done';
        else if (i === index) cls += ' active';
        progressDots += `<span class="${cls}"></span>`;
    }

    // Build options HTML
    let optionsHtml = '';

    if (q.type === 'single') {
        optionsHtml = `<div class="options">
            ${q.options.map(opt => `
                <button class="opt-btn" data-qid="${q.id}" data-value="${opt.value}">
                    ${opt.label}
                </button>
            `).join('')}
        </div>`;
    }

    else if (q.type === 'multi') {
        const selected = STATE.answers[q.id] || [];
        optionsHtml = `
            <div class="options">
                ${q.options.map(opt => `
                    <button class="opt-btn multi ${selected.includes(opt.value) ? 'selected' : ''}"
                            data-qid="${q.id}" data-value="${opt.value}">
                        <span class="checkbox">${selected.includes(opt.value) ? '‚úì' : ''}</span>
                        ${opt.label}
                    </button>
                `).join('')}
            </div>
            <div class="card-actions">
                ${index > 0 ? '<button class="btn btn-back">‚Üê Terug</button>' : ''}
                <button class="btn btn-next" ${selected.length === 0 ? 'disabled' : ''}>
                    Volgende ‚Üí
                </button>
            </div>
        `;
    }

    else if (q.type === 'photo') {
        const photoData = STATE.photos[q.photoType];
        optionsHtml = `
            <div class="photo-area ${photoData ? 'has-photo' : ''}" data-photo-type="${q.photoType}">
                <input type="file" accept="image/*" onchange="handlePhotoUpload(event, '${q.photoType}')">
                <div class="photo-icon">${photoData ? '‚úÖ' : 'üì∑'}</div>
                <div>${photoData ? 'Foto toegevoegd - klik om te wijzigen' : 'Tik om een foto te kiezen'}</div>
                ${photoData ? `<div class="photo-preview"><img src="${photoData}" alt="Preview"></div>` : ''}
            </div>
            <div class="card-actions">
                ${index > 0 ? '<button class="btn btn-back">‚Üê Terug</button>' : ''}
                <button class="btn btn-next">${q.optional ? 'Overslaan ‚Üí' : 'Volgende ‚Üí'}</button>
            </div>
        `;
    }

    else if (q.type === 'text') {
        const currentValue = STATE.answers[q.id] || '';
        optionsHtml = `
            <textarea class="text-input" id="textInput" placeholder="${q.placeholder || 'Type hier...'}">${currentValue}</textarea>
            <div class="card-actions">
                ${index > 0 ? '<button class="btn btn-back">‚Üê Terug</button>' : ''}
                <button class="btn btn-next">Afronden ‚Üí</button>
            </div>
        `;
    }

    // Render card
    const cardHtml = `
        <div class="card" id="questionCard">
            <div class="card-progress">
                <div class="progress-dots">${progressDots}</div>
                <span>Vraag ${index + 1} van ${total}</span>
            </div>
            <div class="card-question">${q.question}</div>
            ${q.hint ? `<div class="card-hint">${q.hint}</div>` : ''}
            ${optionsHtml}
        </div>
    `;

    // Remove old card if exists
    const oldCard = $('questionCard');
    if (oldCard) oldCard.remove();

    // Add new card
    chat.insertAdjacentHTML('beforeend', cardHtml);
    scrollToBottom();
}

// ============================================
// QUESTION HANDLERS
// ============================================
function handleSingleSelect(qid, value, btn) {
    STATE.isTransitioning = true;

    // Save answer
    STATE.answers[qid] = value;

    // Visual feedback
    const container = btn.closest('.options');
    container.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');

    // Show user's choice
    const label = btn.textContent.trim();
    setTimeout(() => {
        addMessage('user', label);
    }, 200);

    // Go to next question
    setTimeout(() => {
        STATE.isTransitioning = false;
        goNext();
    }, 400);
}

function handleMultiSelect(qid, value, btn) {
    // Initialize array if needed
    if (!STATE.answers[qid]) {
        STATE.answers[qid] = [];
    }

    // Toggle selection
    const arr = STATE.answers[qid];
    const idx = arr.indexOf(value);

    if (idx > -1) {
        arr.splice(idx, 1);
        btn.classList.remove('selected');
        btn.querySelector('.checkbox').textContent = '';
    } else {
        arr.push(value);
        btn.classList.add('selected');
        btn.querySelector('.checkbox').textContent = '‚úì';
    }

    // Update next button
    const card = btn.closest('.card');
    const nextBtn = card.querySelector('.btn-next');
    if (nextBtn) {
        nextBtn.disabled = arr.length === 0;
    }
}

// Global function for photo upload (called from onchange)
window.handlePhotoUpload = function(e, photoType) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
        STATE.photos[photoType] = ev.target.result;

        // Update UI
        const photoArea = document.querySelector(`[data-photo-type="${photoType}"]`);
        if (photoArea) {
            photoArea.classList.add('has-photo');
            photoArea.querySelector('.photo-icon').textContent = '‚úÖ';
            photoArea.querySelector('.photo-icon').nextElementSibling.textContent = 'Foto toegevoegd - klik om te wijzigen';

            // Add/update preview
            let preview = photoArea.querySelector('.photo-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.className = 'photo-preview';
                photoArea.appendChild(preview);
            }
            preview.innerHTML = `<img src="${ev.target.result}" alt="Preview">`;
        }
    };
    reader.readAsDataURL(file);
};

function goNext() {
    const visibleQuestions = getVisibleQuestions();
    const currentQ = visibleQuestions[STATE.currentStep];

    // Save text input if applicable
    if (currentQ && currentQ.type === 'text') {
        const textInput = $('textInput');
        if (textInput) {
            STATE.answers[currentQ.id] = textInput.value;
        }
    }

    // Show user's multi-select choices
    if (currentQ && currentQ.type === 'multi' && STATE.answers[currentQ.id]?.length > 0) {
        const labels = STATE.answers[currentQ.id].map(val => {
            const opt = currentQ.options.find(o => o.value === val);
            return opt ? opt.label : val;
        });
        addMessage('user', labels.join(', '));
    }

    showQuestion(STATE.currentStep + 1);
}

function goBack() {
    if (STATE.currentStep > 0) {
        showQuestion(STATE.currentStep - 1);
    }
}

// ============================================
// FINISH & AI
// ============================================
function finishIntake() {
    // Remove question card
    const card = $('questionCard');
    if (card) card.remove();

    addMessage('bot', '‚úÖ Bedankt! Ik analyseer je gegevens...');
    showTyping();

    setTimeout(() => generateAdvice(), 500);
}

async function generateAdvice() {
    try {
        const prompt = buildPrompt();
        const response = await callGeminiAPI(prompt);
        hideTyping();
        showResult(response);
    } catch (error) {
        hideTyping();
        console.error('API Error:', error);

        let errorMsg = 'Er ging iets mis.';
        if (error.message.includes('401') || error.message.includes('403')) {
            errorMsg = '‚ö†Ô∏è API key ongeldig. Controleer je key in ‚öôÔ∏è instellingen.';
        } else if (error.message.includes('429')) {
            errorMsg = '‚ö†Ô∏è Te veel verzoeken. Wacht even en probeer opnieuw.';
        }

        chat.insertAdjacentHTML('beforeend', `<div class="error">${errorMsg}</div>`);
        scrollToBottom();
    }
}

function buildPrompt() {
    let prompt = `Je bent een vriendelijke haaradviseur voor kapsalon Haarvisie.
Geef persoonlijk advies op basis van deze intake:

`;

    // Add all answers
    const labels = {
        service: 'Gewenste behandeling',
        current_color: 'Huidige kleur',
        colored_before: 'Eerder geverfd',
        color_history: 'Kleurhistorie',
        hair_condition: 'Haarkwaliteit',
        products: 'Thuisproducten',
        extra_wish: 'Extra wens'
    };

    for (const [key, label] of Object.entries(labels)) {
        const value = STATE.answers[key];
        if (value) {
            const displayValue = Array.isArray(value) ? value.join(', ') : value;
            prompt += `‚Ä¢ ${label}: ${displayValue}\n`;
        }
    }

    prompt += `
PRIJSINDICATIES:
- Knippen: vanaf ‚Ç¨45
- Kleuren: vanaf ‚Ç¨95
- Highlights: vanaf ‚Ç¨125
- Balayage: vanaf ‚Ç¨185

Geef een warm, persoonlijk advies met:
1. Aanbeveling op basis van de gegevens
2. Eventuele aandachtspunten/waarschuwingen
3. Geschatte prijsindicatie
4. Thuisverzorgingstip

Houd het beknopt maar informatief. Gebruik emoji's.`;

    return prompt;
}

async function callGeminiAPI(prompt) {
    const parts = [{ text: prompt }];

    // Add photos if available
    if (STATE.photos.current) {
        const base64 = STATE.photos.current.split(',')[1];
        parts.push({ inlineData: { mimeType: 'image/jpeg', data: base64 } });
    }
    if (STATE.photos.wish) {
        const base64 = STATE.photos.wish.split(',')[1];
        parts.push({ inlineData: { mimeType: 'image/jpeg', data: base64 } });
    }

    const response = await fetch(`${CONFIG.API_URL}?key=${STATE.apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
        })
    });

    if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
    }

    const data = await response.json();

    if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
        throw new Error('Invalid API response');
    }

    return data.candidates[0].content.parts[0].text;
}

function showResult(text) {
    // Format text
    let formatted = text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/‚Ç¨(\d+)/g, '<span class="price-tag">‚Ç¨$1</span>')
        .replace(/\n/g, '<br>');

    const html = `
        <div class="result">
            <h3>‚ú® Jouw Persoonlijk Advies</h3>
            <div class="result-content">${formatted}</div>
            <div class="result-actions">
                <button class="btn-feedback good" data-action="feedback-good">üëç Nuttig</button>
                <button class="btn-feedback question" data-action="feedback-question">üí¨ Vraag stellen</button>
            </div>
        </div>
        <button class="btn btn-next" style="margin-top: 16px;" data-action="new-intake">
            üîÑ Nieuwe intake starten
        </button>
    `;

    chat.insertAdjacentHTML('beforeend', html);
    scrollToBottom();
}

// ============================================
// FOLLOW-UP QUESTIONS
// ============================================
async function sendFollowUp() {
    const input = $('followUpInput');
    const question = input.value.trim();

    if (!question) return;

    input.value = '';
    addMessage('user', question);
    showTyping();

    try {
        const prompt = `Je bent Haarvisie AI. De klant heeft een vervolgvraag: "${question}"

Beantwoord kort en vriendelijk in het Nederlands.`;

        const response = await callGeminiAPI(prompt);
        hideTyping();
        addMessage('bot', response);
    } catch (error) {
        hideTyping();
        addMessage('bot', '‚ö†Ô∏è Kon geen antwoord genereren. Probeer het opnieuw.');
    }
}

// ============================================
// UI HELPERS
// ============================================
function addMessage(type, text) {
    // Format if bot message
    let content = text;
    if (type === 'bot') {
        content = text
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/‚Ç¨(\d+)/g, '<span class="price-tag">‚Ç¨$1</span>')
            .replace(/\n/g, '<br>');
    }

    const html = `
        <div class="msg ${type}">
            <div class="msg-content">${content}</div>
        </div>
    `;
    chat.insertAdjacentHTML('beforeend', html);
    scrollToBottom();
}

function showTyping() {
    const html = `
        <div class="msg bot" id="typingIndicator">
            <div class="typing">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
                <div class="typing-text">AI denkt na...</div>
            </div>
        </div>
    `;
    chat.insertAdjacentHTML('beforeend', html);
    scrollToBottom();
}

function hideTyping() {
    const el = $('typingIndicator');
    if (el) el.remove();
}

function scrollToBottom() {
    setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
    }, 50);
}
</script>
</body>
</html>
