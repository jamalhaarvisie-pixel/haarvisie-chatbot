<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Haarvisie AI Chatbot + Intake</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
.chat-container{width:100%;max-width:900px;height:90vh;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);display:flex;flex-direction:column;overflow:hidden}
.chat-header{background:linear-gradient(135deg,#2c3e50 0%,#4a5568 100%);color:white;padding:15px 20px;display:flex;align-items:center;gap:15px}
.logo{width:45px;height:45px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px}
.header-info h1{font-size:1.3rem;margin-bottom:2px}
.header-info p{font-size:0.8rem;opacity:0.8}
.header-buttons{margin-left:auto;display:flex;gap:8px;align-items:center}
.header-btn{padding:6px 12px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem;transition:all 0.2s}
.header-btn:hover{background:rgba(255,255,255,0.3)}
.api-status{padding:6px 12px;border-radius:15px;font-size:0.75rem;font-weight:600}
.api-status.connected{background:#48bb78}
.api-status.disconnected{background:#f56565}
.chat-messages{flex:1;overflow-y:auto;padding:20px;background:#f7fafc}
.message{max-width:85%;margin-bottom:15px;animation:fadeIn 0.3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.message.user{margin-left:auto}
.message.bot{margin-right:auto}
.message-content{padding:15px 20px;border-radius:18px;line-height:1.5}
.message.user .message-content{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-bottom-right-radius:4px}
.message.bot .message-content{background:white;color:#2d3748;border-bottom-left-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.intake-question{margin-top:15px;padding:20px;background:#f0f4ff;border-radius:12px;border-left:4px solid #667eea}
.intake-question h4{color:#2d3748;margin-bottom:12px;font-size:1.05rem}
.intake-question p.description{font-size:0.85rem;color:#718096;margin-bottom:12px}
.intake-options{display:flex;flex-wrap:wrap;gap:10px}
.intake-btn{padding:12px 18px;background:white;border:2px solid #e2e8f0;border-radius:25px;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:flex;align-items:center;gap:8px}
.intake-btn:hover{border-color:#667eea;background:#f0f4ff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.2)}
.intake-btn.selected{background:#667eea;color:white;border-color:#667eea;transform:scale(1.02)}
.intake-btn.multi{border-radius:10px}
.intake-btn.multi.selected{background:#48bb78;border-color:#48bb78}
.intake-checkbox{width:20px;height:20px;border:2px solid #cbd5e0;border-radius:5px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.intake-btn.selected .intake-checkbox{background:white;border-color:white}
.intake-btn.selected .intake-checkbox::after{content:'‚úì';color:#48bb78;font-weight:bold;font-size:14px}
.intake-next{margin-top:15px;padding:14px 28px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:25px;cursor:pointer;font-size:1rem;font-weight:600;transition:all 0.2s;box-shadow:0 4px 15px rgba(102,126,234,0.3)}
.intake-next:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
.intake-next:not(:disabled):hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.4)}
.intake-progress{display:flex;gap:6px;margin-bottom:15px;align-items:center}
.progress-dot{width:10px;height:10px;border-radius:50%;background:#e2e8f0;transition:all 0.3s}
.progress-dot.active{background:#667eea;transform:scale(1.3)}
.progress-dot.done{background:#48bb78}
.progress-label{margin-left:10px;font-size:0.8rem;color:#718096}
.photo-upload-area{margin-top:12px;padding:25px;border:2px dashed #cbd5e0;border-radius:12px;text-align:center;cursor:pointer;transition:all 0.2s}
.photo-upload-area:hover{border-color:#667eea;background:#f0f4ff}
.photo-upload-area.has-photo{border-style:solid;border-color:#48bb78;background:#f0fff4}
.uploaded-preview{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:center}
.uploaded-preview img{width:100px;height:100px;object-fit:cover;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.chat-input-area{padding:15px 20px;background:white;border-top:1px solid #e2e8f0}
.input-row{display:flex;gap:10px;align-items:flex-end}
.input-wrapper{flex:1;position:relative}
.input-wrapper textarea{width:100%;padding:12px 45px 12px 15px;border:2px solid #e2e8f0;border-radius:20px;font-size:0.95rem;resize:none;min-height:45px;max-height:120px}
.input-wrapper textarea:focus{outline:none;border-color:#667eea}
.attach-btn{position:absolute;right:12px;bottom:10px;background:none;border:none;cursor:pointer;font-size:1.2rem;opacity:0.6}
.attach-btn:hover{opacity:1}
.send-btn{width:45px;height:45px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:50%;cursor:pointer;font-size:1.1rem;transition:all 0.2s}
.send-btn:hover{transform:scale(1.05)}
.panel{display:none;padding:15px 20px;background:#f7fafc;border-bottom:1px solid #e2e8f0}
.panel.active{display:block}
.settings-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.settings-row label{font-weight:600;color:#4a5568}
.settings-row input{flex:1;padding:10px 14px;border:2px solid #e2e8f0;border-radius:8px;min-width:200px;font-size:0.95rem}
.settings-row input:focus{outline:none;border-color:#667eea}
.settings-btn{padding:10px 20px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s}
.settings-btn:hover{background:#5a67d8}
.typing-indicator{display:flex;gap:5px;padding:15px 20px;background:white;border-radius:18px;width:fit-content;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.typing-indicator span{width:8px;height:8px;background:#a0aec0;border-radius:50%;animation:typing 1.4s infinite}
.typing-indicator span:nth-child(2){animation-delay:0.2s}
.typing-indicator span:nth-child(3){animation-delay:0.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
.feedback-bar{display:flex;gap:8px;margin-top:12px}
.feedback-btn{padding:8px 14px;border:none;border-radius:20px;cursor:pointer;font-size:0.85rem;display:flex;align-items:center;gap:6px;transition:all 0.2s}
.feedback-btn.good{background:#c6f6d5;color:#22543d}
.feedback-btn.good:hover{background:#9ae6b4}
.feedback-btn.correct{background:#fed7d7;color:#822727}
.feedback-btn.correct:hover{background:#feb2b2}
#fileInput{display:none}
.price-tag{display:inline-block;background:linear-gradient(135deg,#48bb78 0%,#38a169 100%);color:white;padding:4px 12px;border-radius:15px;font-weight:600;font-size:0.85rem;margin:2px}
.selection-hint{font-size:0.8rem;color:#718096;margin-top:8px;font-style:italic}
</style>
</head>
<body>
<div class="chat-container">
<div class="chat-header">
<div class="logo">H</div>
<div class="header-info"><h1>Haarvisie AI Assistent</h1><p>Persoonlijk haaradvies</p></div>
<div class="header-buttons">
<button class="header-btn" id="intakeBtn">üéØ Start Intake</button>
<button class="header-btn" id="settingsBtn">‚öôÔ∏è</button>
<div class="api-status disconnected" id="apiStatus">Niet verbonden</div>
</div>
</div>
<div class="panel" id="settingsPanel">
<div class="settings-row">
<label>API Key:</label>
<input type="password" id="apiKeyInput" placeholder="Voer je Gemini API key in">
<button class="settings-btn" id="saveKeyBtn">‚úì Opslaan</button>
</div>
</div>
<div class="chat-messages" id="chatMessages">
<div class="message bot" id="welcomeMsg">
<div class="message-content">
<strong>üëã Welkom bij Haarvisie!</strong><br><br>
<div id="setupPrompt" style="display:none;background:#fff3cd;padding:12px;border-radius:10px;margin-bottom:12px;">
‚ö†Ô∏è <strong>Eerst instellen:</strong> Klik op ‚öôÔ∏è en voer je API key in.<br>
<small style="color:#856404">Verkrijg je key op: <a href="https://aistudio.google.com/apikey" target="_blank" style="color:#667eea">aistudio.google.com/apikey</a></small>
</div>
<div id="readyPrompt" style="display:none;">
‚úÖ <strong>AI is klaar!</strong><br><br>
Klik op <strong>üéØ Start Intake</strong> voor persoonlijk advies, of stel direct een vraag hieronder.
</div>
</div>
</div>
</div>
<div class="chat-input-area">
<div class="input-row">
<div class="input-wrapper">
<textarea id="messageInput" placeholder="Stel hier je vraag..." rows="1"></textarea>
<button class="attach-btn" id="attachBtn">üìé</button>
</div>
<button class="send-btn" id="sendBtn">‚û§</button>
</div>
<input type="file" id="fileInput" multiple accept="image/*">
</div>
</div>

<script>
// ===========================================
// HAARVISIE AI CHATBOT - IMPROVED VERSION
// ===========================================

let API_KEY = localStorage.getItem('gemini_api_key') || '';
const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
let uploadedPhotos = [];
let intakeData = {};
let currentQuestion = 0;
let currentPhotoType = 'current';
let messageCounter = 0;
let intakeActive = false; // Track if intake is running

const INTAKE_QUESTIONS = [
    {
        id: 'service',
        question: 'Welke behandeling zoek je?',
        type: 'single',
        options: [
            {value: 'knippen', label: '‚úÇÔ∏è Knippen'},
            {value: 'kleuren', label: 'üé® Kleuren'},
            {value: 'highlights', label: 'üåü Highlights/Balayage'},
            {value: 'behandeling', label: 'üíÜ Behandeling'},
            {value: 'styling', label: 'üíÖ Styling/F√∂hnen'},
            {value: 'combinatie', label: 'üì¶ Combinatie'}
        ]
    },
    {
        id: 'current_color',
        question: 'Wat is je huidige haarkleur?',
        type: 'single',
        options: [
            {value: 'blond', label: 'üë± Blond'},
            {value: 'bruin', label: 'ü§é Bruin'},
            {value: 'zwart', label: '‚¨õ Zwart'},
            {value: 'rood', label: 'üî¥ Rood'},
            {value: 'grijs', label: '‚¨ú Grijs/wit'},
            {value: 'gekleurd', label: 'üåà Fantasie kleur'}
        ]
    },
    {
        id: 'colored_before',
        question: 'Is je haar eerder gekleurd?',
        type: 'single',
        options: [
            {value: 'nee', label: '‚ùå Nee, natuurlijk'},
            {value: 'ja_salon', label: 'üíá Ja, bij salon'},
            {value: 'ja_zelf', label: 'üè† Ja, thuis'},
            {value: 'ja_beide', label: 'üîÑ Beide'}
        ]
    },
    {
        id: 'color_history',
        question: 'Wat is er de afgelopen 2 jaar gedaan?',
        description: 'Selecteer alles wat van toepassing is',
        type: 'multi',
        options: [
            {value: 'highlights', label: 'üåü Highlights'},
            {value: 'ontkleurd', label: '‚ö° Gebleekt'},
            {value: 'donkerder', label: 'üåë Donkerder'},
            {value: 'henna', label: 'üåø Henna'},
            {value: 'permanent', label: 'üîÑ Permanent'},
            {value: 'niets', label: '‚ú® Niets'}
        ]
    },
    {
        id: 'hair_condition',
        question: 'Hoe zou je je haarkwaliteit omschrijven?',
        type: 'single',
        options: [
            {value: 'gezond', label: 'üí™ Gezond'},
            {value: 'normaal', label: 'üëç Normaal'},
            {value: 'droog', label: 'üèúÔ∏è Droog'},
            {value: 'beschadigd', label: '‚ö†Ô∏è Beschadigd'},
            {value: 'dun', label: 'ü™∂ Fijn/dun'}
        ]
    },
    {
        id: 'products',
        question: 'Welke producten gebruik je thuis?',
        description: 'Selecteer alles wat van toepassing is',
        type: 'multi',
        options: [
            {value: 'olaplex', label: 'üíé Olaplex'},
            {value: 'kerastase', label: 'üß¥ K√©rastase'},
            {value: 'andrelon', label: 'üõí Supermarkt'},
            {value: 'masker', label: 'üé≠ Maskers'},
            {value: 'hittetools', label: 'üî• Hittetools'},
            {value: 'geen', label: '‚ùå Geen'}
        ]
    },
    {
        id: 'photo_current',
        question: 'üì∏ Upload een foto van je huidige haar',
        description: 'Optioneel - maak een foto in daglicht voor beste resultaat',
        type: 'photo',
        photoType: 'current'
    },
    {
        id: 'photo_wish',
        question: 'üéØ Heb je een inspiratiefoto?',
        description: 'Optioneel - upload je droomkapsel of kleur',
        type: 'photo',
        photoType: 'wish'
    },
    {
        id: 'wish',
        question: 'Nog iets toevoegen?',
        description: 'Optioneel - beschrijf je wens of stel een vraag',
        type: 'text',
        placeholder: 'Bijv: Ik wil lichter worden met een natuurlijke uitstraling...'
    }
];

// ===========================================
// INITIALIZATION
// ===========================================
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    // Check API key status
    checkApiKey();

    // Header buttons
    document.getElementById('intakeBtn').onclick = startIntake;
    document.getElementById('settingsBtn').onclick = togglePanel;
    document.getElementById('saveKeyBtn').onclick = saveApiKey;

    // Chat input
    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('attachBtn').onclick = function() {
        document.getElementById('fileInput').click();
    };
    document.getElementById('fileInput').onchange = handleFileSelect;
    document.getElementById('messageInput').onkeydown = function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };

    // SINGLE event delegation handler for all intake interactions
    document.getElementById('chatMessages').onclick = handleChatClick;
}

// ===========================================
// EVENT DELEGATION - Single handler for all clicks
// ===========================================
function handleChatClick(e) {
    var target = e.target;

    // Find the actual button if we clicked on a child element
    var btn = target.closest('.intake-btn');
    var nextBtn = target.closest('.intake-next');
    var photoArea = target.closest('.photo-upload-area');

    // Handle single-select button
    if (btn && !btn.classList.contains('multi') && btn.hasAttribute('data-qid')) {
        e.preventDefault();
        e.stopPropagation();
        var qid = btn.getAttribute('data-qid');
        var val = btn.getAttribute('data-value');
        handleSingleSelect(qid, val, btn);
        return;
    }

    // Handle multi-select button
    if (btn && btn.classList.contains('multi') && btn.hasAttribute('data-qid')) {
        e.preventDefault();
        e.stopPropagation();
        var qid = btn.getAttribute('data-qid');
        var val = btn.getAttribute('data-value');
        handleMultiSelect(qid, val, btn);
        return;
    }

    // Handle "Volgende" button
    if (nextBtn && !nextBtn.disabled) {
        e.preventDefault();
        e.stopPropagation();
        goToNextQuestion();
        return;
    }

    // Handle photo upload area
    if (photoArea && target.tagName !== 'INPUT') {
        var photoInput = photoArea.querySelector('input[type="file"]');
        if (photoInput) {
            photoInput.click();
        }
        return;
    }
}

// ===========================================
// INTAKE FLOW
// ===========================================
function startIntake() {
    if (intakeActive) return; // Prevent double-start

    intakeActive = true;
    intakeData = {};
    currentQuestion = 0;
    uploadedPhotos = [];

    addBotMessage('üìã <strong>Persoonlijke Intake</strong><br><br>Beantwoord een paar korte vragen zodat ik je het beste kan adviseren. Dit duurt ongeveer 2 minuten.');

    setTimeout(function() {
        showQuestion(currentQuestion);
    }, 600);
}

function showQuestion(qIndex) {
    console.log('showQuestion called with index:', qIndex);

    if (qIndex >= INTAKE_QUESTIONS.length) {
        finishIntake();
        return;
    }

    var q = INTAKE_QUESTIONS[qIndex];

    // Build progress indicator
    var progressHtml = '<div class="intake-progress">';
    for (var i = 0; i < INTAKE_QUESTIONS.length; i++) {
        var dotClass = 'progress-dot';
        if (i < qIndex) dotClass += ' done';
        else if (i === qIndex) dotClass += ' active';
        progressHtml += '<span class="' + dotClass + '"></span>';
    }
    progressHtml += '<span class="progress-label">Vraag ' + (qIndex + 1) + ' van ' + INTAKE_QUESTIONS.length + '</span>';
    progressHtml += '</div>';

    // Build question content
    var content = '<div class="intake-question" data-question-index="' + qIndex + '">';
    content += progressHtml;
    content += '<h4>' + q.question + '</h4>';

    if (q.description) {
        content += '<p class="description">' + q.description + '</p>';
    }

    if (q.type === 'single') {
        content += '<div class="intake-options">';
        for (var j = 0; j < q.options.length; j++) {
            var opt = q.options[j];
            content += '<button class="intake-btn" data-qid="' + q.id + '" data-value="' + opt.value + '">' + opt.label + '</button>';
        }
        content += '</div>';
    }
    else if (q.type === 'multi') {
        content += '<div class="intake-options">';
        for (var k = 0; k < q.options.length; k++) {
            var mopt = q.options[k];
            content += '<button class="intake-btn multi" data-qid="' + q.id + '" data-value="' + mopt.value + '"><span class="intake-checkbox"></span>' + mopt.label + '</button>';
        }
        content += '</div>';
        content += '<p class="selection-hint">üí° Selecteer minimaal 1 optie</p>';
        content += '<button class="intake-next" disabled>Volgende ‚Üí</button>';
    }
    else if (q.type === 'photo') {
        currentPhotoType = q.photoType || 'current';
        content += '<div class="photo-upload-area">';
        content += '<input type="file" accept="image/*" multiple style="display:none" onchange="handleIntakePhoto(event)">';
        content += 'üì∑ Tik hier om een foto te kiezen';
        content += '<div class="uploaded-preview"></div>';
        content += '</div>';
        content += '<button class="intake-next">Overslaan / Volgende ‚Üí</button>';
    }
    else if (q.type === 'text') {
        content += '<textarea class="intake-textarea" placeholder="' + (q.placeholder || 'Type hier...') + '" style="width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:12px;min-height:100px;font-size:0.95rem;margin-top:10px;resize:none;font-family:inherit"></textarea>';
        content += '<button class="intake-next">Afronden ‚Üí</button>';
    }

    content += '</div>';

    addBotHtml(content);
}

function handleSingleSelect(qid, val, btn) {
    console.log('handleSingleSelect:', qid, val);

    // Store the answer
    intakeData[qid] = val;

    // Visual feedback - mark as selected
    var container = btn.closest('.intake-options');
    if (container) {
        var allBtns = container.querySelectorAll('.intake-btn');
        allBtns.forEach(function(b) {
            b.classList.remove('selected');
        });
    }
    btn.classList.add('selected');

    // Go to next question after brief delay for visual feedback
    setTimeout(function() {
        currentQuestion++;
        showQuestion(currentQuestion);
    }, 350);
}

function handleMultiSelect(qid, val, btn) {
    console.log('handleMultiSelect:', qid, val);

    // Initialize array if needed
    if (!intakeData[qid]) {
        intakeData[qid] = [];
    }

    // Toggle selection
    var idx = intakeData[qid].indexOf(val);
    if (idx > -1) {
        intakeData[qid].splice(idx, 1);
        btn.classList.remove('selected');
    } else {
        intakeData[qid].push(val);
        btn.classList.add('selected');
    }

    // Update the "Volgende" button state
    var questionContainer = btn.closest('.intake-question');
    if (questionContainer) {
        var nextBtn = questionContainer.querySelector('.intake-next');
        var hint = questionContainer.querySelector('.selection-hint');
        if (nextBtn) {
            var hasSelection = intakeData[qid].length > 0;
            nextBtn.disabled = !hasSelection;
            if (hint) {
                hint.textContent = hasSelection ? '‚úì ' + intakeData[qid].length + ' geselecteerd' : 'üí° Selecteer minimaal 1 optie';
                hint.style.color = hasSelection ? '#48bb78' : '#718096';
            }
        }
    }
}

function goToNextQuestion() {
    console.log('goToNextQuestion called, current:', currentQuestion);

    // For text questions, save the input
    var currentQ = INTAKE_QUESTIONS[currentQuestion];
    if (currentQ && currentQ.type === 'text') {
        var allQuestions = document.querySelectorAll('.intake-question');
        var lastQuestion = allQuestions[allQuestions.length - 1];
        if (lastQuestion) {
            var textarea = lastQuestion.querySelector('textarea');
            if (textarea) {
                intakeData[currentQ.id] = textarea.value;
            }
        }
    }

    currentQuestion++;
    showQuestion(currentQuestion);
}

// Make this function global for the inline onchange handler
window.handleIntakePhoto = function(e) {
    var files = e.target.files;
    for (var i = 0; i < files.length; i++) {
        var f = files[i];
        if (f.type.startsWith('image/')) {
            var reader = new FileReader();
            reader.onload = function(ev) {
                uploadedPhotos.push({data: ev.target.result, type: currentPhotoType});
                updatePhotoPreview();
            };
            reader.readAsDataURL(f);
        }
    }
};

function updatePhotoPreview() {
    var photos = uploadedPhotos.filter(function(p) {
        return p.type === currentPhotoType;
    });

    var areas = document.querySelectorAll('.photo-upload-area');
    var area = areas[areas.length - 1];

    if (area && photos.length > 0) {
        area.classList.add('has-photo');
        var preview = area.querySelector('.uploaded-preview');
        if (preview) {
            var html = '';
            for (var i = 0; i < photos.length; i++) {
                html += '<img src="' + photos[i].data + '" alt="Uploaded">';
            }
            preview.innerHTML = html;
        }
        // Update text
        var textNode = area.childNodes[0];
        if (textNode && textNode.nodeType === 3) {
            textNode.textContent = '‚úÖ ' + photos.length + ' foto ge√ºpload - klik om meer toe te voegen';
        }
    }
}

function finishIntake() {
    intakeActive = false;
    addBotMessage('‚úÖ <strong>Bedankt!</strong><br><br>Ik analyseer je gegevens en maak een persoonlijk advies...');
    showTyping();

    setTimeout(function() {
        generateAdvice();
    }, 500);
}

// ===========================================
// API FUNCTIONS
// ===========================================
function checkApiKey() {
    var statusEl = document.getElementById('apiStatus');
    var setupPrompt = document.getElementById('setupPrompt');
    var readyPrompt = document.getElementById('readyPrompt');
    var apiKeyInput = document.getElementById('apiKeyInput');
    var settingsPanel = document.getElementById('settingsPanel');

    if (API_KEY) {
        // Show masked key in input
        if (apiKeyInput) {
            apiKeyInput.value = API_KEY;
        }
        statusEl.textContent = '‚úì Verbonden';
        statusEl.className = 'api-status connected';
        if (setupPrompt) setupPrompt.style.display = 'none';
        if (readyPrompt) readyPrompt.style.display = 'block';
        settingsPanel.classList.remove('active');
    } else {
        statusEl.textContent = '‚úó Niet verbonden';
        statusEl.className = 'api-status disconnected';
        if (setupPrompt) setupPrompt.style.display = 'block';
        if (readyPrompt) readyPrompt.style.display = 'none';
        settingsPanel.classList.add('active');
    }
}

function togglePanel() {
    document.getElementById('settingsPanel').classList.toggle('active');
}

function saveApiKey() {
    var input = document.getElementById('apiKeyInput');
    API_KEY = input.value.trim();

    if (API_KEY) {
        localStorage.setItem('gemini_api_key', API_KEY);
        checkApiKey();
        addBotMessage('‚úÖ API key opgeslagen! Je kunt nu de intake starten.');
    } else {
        addBotMessage('‚ö†Ô∏è Voer een geldige API key in.');
    }
}

async function generateAdvice() {
    if (!API_KEY) {
        hideTyping();
        addBotMessage('‚ö†Ô∏è Voer eerst je API key in via ‚öôÔ∏è Settings');
        return;
    }

    try {
        var response = await callGeminiAPI();
        hideTyping();
        addBotMsgFb(response);
    } catch(e) {
        hideTyping();
        console.error('API Error:', e);
        addBotMessage('‚ö†Ô∏è Er ging iets mis: ' + e.message + '<br><br>Controleer je API key in Settings.');
    }
}

async function callGeminiAPI() {
    var prompt = 'Je bent Haarvisie AI, een vriendelijke en professionele haaradviseur voor een Nederlandse kapsalon. ';
    prompt += 'Geef persoonlijk advies op basis van deze intake gegevens:\n\n';
    prompt += '‚Ä¢ Gewenste behandeling: ' + (intakeData.service || 'niet opgegeven') + '\n';
    prompt += '‚Ä¢ Huidige kleur: ' + (intakeData.current_color || 'niet opgegeven') + '\n';
    prompt += '‚Ä¢ Eerder gekleurd: ' + (intakeData.colored_before || 'niet opgegeven') + '\n';
    prompt += '‚Ä¢ Kleurhistorie (2 jaar): ' + (intakeData.color_history ? intakeData.color_history.join(', ') : 'niet opgegeven') + '\n';
    prompt += '‚Ä¢ Haarkwaliteit: ' + (intakeData.hair_condition || 'niet opgegeven') + '\n';
    prompt += '‚Ä¢ Thuisproducten: ' + (intakeData.products ? intakeData.products.join(', ') : 'niet opgegeven') + '\n';
    prompt += '‚Ä¢ Extra wens: ' + (intakeData.wish || 'geen') + '\n\n';
    prompt += 'PRIJSINDICATIES: Knippen vanaf ‚Ç¨45, Kleuren vanaf ‚Ç¨95, Highlights vanaf ‚Ç¨125, Balayage vanaf ‚Ç¨185, Full colour ‚Ç¨175.\n\n';
    prompt += 'Geef een warm, persoonlijk advies met:\n';
    prompt += '1. Wat je aanraadt op basis van de gegevens\n';
    prompt += '2. Eventuele waarschuwingen of aandachtspunten\n';
    prompt += '3. Geschatte prijsindicatie\n';
    prompt += '4. Tip voor thuisverzorging\n\n';
    prompt += 'Houd het beknopt maar informatief. Gebruik emoji voor een vriendelijke uitstraling.';

    var parts = [{text: prompt}];

    // Add photos if available
    var currentPhotos = uploadedPhotos.filter(function(p) { return p.type === 'current'; });
    for (var i = 0; i < currentPhotos.length; i++) {
        var imgData = currentPhotos[i].data.split(',')[1];
        parts.push({inlineData: {mimeType: 'image/jpeg', data: imgData}});
    }

    var wishPhotos = uploadedPhotos.filter(function(p) { return p.type === 'wish'; });
    for (var j = 0; j < wishPhotos.length; j++) {
        var wishData = wishPhotos[j].data.split(',')[1];
        parts.push({inlineData: {mimeType: 'image/jpeg', data: wishData}});
    }

    var response = await fetch(API_URL + '?key=' + API_KEY, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            contents: [{parts: parts}],
            generationConfig: {temperature: 0.7, maxOutputTokens: 1024}
        })
    });

    if (!response.ok) {
        var errorData = await response.json().catch(function() { return {}; });
        var errorMsg = errorData.error ? errorData.error.message : 'HTTP ' + response.status;
        throw new Error(errorMsg);
    }

    var data = await response.json();

    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
        throw new Error('Onverwacht API antwoord');
    }

    return data.candidates[0].content.parts[0].text;
}

// ===========================================
// MESSAGE FUNCTIONS
// ===========================================
function addUserMsg(text) {
    var html = '<div class="message user"><div class="message-content">' + escHtml(text) + '</div></div>';
    document.getElementById('chatMessages').insertAdjacentHTML('beforeend', html);
    scrollToBottom();
}

function addBotMessage(text) {
    var html = '<div class="message bot"><div class="message-content">' + text + '</div></div>';
    document.getElementById('chatMessages').insertAdjacentHTML('beforeend', html);
    scrollToBottom();
}

function addBotHtml(html) {
    var wrapper = '<div class="message bot"><div class="message-content">' + html + '</div></div>';
    document.getElementById('chatMessages').insertAdjacentHTML('beforeend', wrapper);
    scrollToBottom();
}

function addBotMsgFb(text) {
    messageCounter++;
    var id = 'msg_' + messageCounter;
    var html = '<div class="message bot" id="' + id + '"><div class="message-content">' + formatMessage(text);
    html += '<div class="feedback-bar">';
    html += '<button class="feedback-btn good" onclick="giveFeedback(\'' + id + '\', \'good\')">üëç Nuttig</button>';
    html += '<button class="feedback-btn correct" onclick="giveFeedback(\'' + id + '\', \'correct\')">üí¨ Vraag stellen</button>';
    html += '</div></div></div>';
    document.getElementById('chatMessages').insertAdjacentHTML('beforeend', html);
    scrollToBottom();
}

function formatMessage(text) {
    var formatted = escHtml(text);
    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    formatted = formatted.replace(/‚Ç¨(\d+)/g, '<span class="price-tag">‚Ç¨$1</span>');
    formatted = formatted.replace(/\n/g, '<br>');
    return formatted;
}

function showTyping() {
    var html = '<div id="typing" class="message bot"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
    document.getElementById('chatMessages').insertAdjacentHTML('beforeend', html);
    scrollToBottom();
}

function hideTyping() {
    var typing = document.getElementById('typing');
    if (typing) typing.remove();
}

function scrollToBottom() {
    var msgs = document.getElementById('chatMessages');
    msgs.scrollTop = msgs.scrollHeight;
}

function escHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ===========================================
// CHAT FUNCTIONS
// ===========================================
function handleFileSelect(e) {
    var files = e.target.files;
    for (var i = 0; i < files.length; i++) {
        var f = files[i];
        if (f.type.startsWith('image/')) {
            var reader = new FileReader();
            reader.onload = function(ev) {
                uploadedPhotos.push({data: ev.target.result, type: 'chat'});
            };
            reader.readAsDataURL(f);
        }
    }
}

async function sendMessage() {
    var input = document.getElementById('messageInput');
    var msg = input.value.trim();
    var chatPhotos = uploadedPhotos.filter(function(p) { return p.type === 'chat'; });

    if (!msg && chatPhotos.length === 0) return;

    if (msg) addUserMsg(msg);
    input.value = '';

    if (!API_KEY) {
        addBotMessage('‚ö†Ô∏è Voer eerst je API key in via ‚öôÔ∏è Settings');
        return;
    }

    showTyping();

    try {
        var parts = [{text: 'Je bent Haarvisie AI, een vriendelijke haaradviseur. Beantwoord deze vraag: ' + msg}];

        for (var i = 0; i < chatPhotos.length; i++) {
            var imgData = chatPhotos[i].data.split(',')[1];
            parts.push({inlineData: {mimeType: 'image/jpeg', data: imgData}});
        }

        var response = await fetch(API_URL + '?key=' + API_KEY, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{parts: parts}],
                generationConfig: {temperature: 0.7, maxOutputTokens: 1024}
            })
        });

        if (!response.ok) {
            throw new Error('API fout: ' + response.status);
        }

        var data = await response.json();
        hideTyping();
        addBotMsgFb(data.candidates[0].content.parts[0].text);

        uploadedPhotos = uploadedPhotos.filter(function(p) { return p.type !== 'chat'; });

    } catch(e) {
        hideTyping();
        addBotMessage('‚ö†Ô∏è ' + e.message);
    }
}

window.giveFeedback = function(msgId, type) {
    if (type === 'good') {
        addBotMessage('üòä Fijn dat het advies nuttig was! Kan ik je ergens anders mee helpen?');
    } else {
        addBotMessage('üí¨ Stel gerust je vervolgvraag hieronder!');
    }
};
</script>
</body>
</html>
